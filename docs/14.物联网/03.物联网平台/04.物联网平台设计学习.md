---
title: 04.物联网平台设计学习
date: 2022-04-14 09:10:42
permalink: /platform/stw8ced6/
categories:
  - 物联网
tags:
  - 
---

> 参考博文：
>
> - [物联网平台架构设计_DiegoRobot的博客-CSDN博客_物联网平台架构](https://blog.csdn.net/mwlwlm/article/details/77932633)
> - [物联网平台的产品架构 | 人人都是产品经理 (woshipm.com)](http://www.woshipm.com/pd/4394950.html)
> - [物联网服务端架构 - PetterLiu - 博客园 (cnblogs.com)](https://www.cnblogs.com/wintersun/p/10223554.html)

## 1 物联网平台架构设计

物联网平台，应该是基于现在的互联网，通讯技术来建构，而不依赖与特定的硬件模块，用户可以基于自身的设备技术架构，简单轻松接入物联网。下图是物联网的核心架构：

![这里写图片描述](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwOTExMTM1NzE1MDI0?x-oss-process=image/format,png)

**四大核心模块**

在物联网中存在4大核心模块，那就是**设备管理，用户管理，数据传输管理，数据管理**，只有具备了这四大核心模块，才能认为是一个完整的物联网平台，而所有其他的功能模块都是基于此四大功能模块的延展。

### 1.1 设备管理

**设备类型管理**：定义设备的类型，此功能一般由设备的制造商来定义，一种设备类型最重要的是关联到一套独有的数据解析方法，数据的存储方法，已经设备规格等数据，也只有设备的制造商才可以编辑有关设备类型的数据，而设备的使用者只能浏览设备类型的相关信息

设备管理：设备管理定义设备相关信息，**每个设备必须定义其设备类型**，设备类型有使用者属性，设备在完成销售，并被使用者激活后设备就属于设备使用者了，这时候设备使用者对设备有完全的控制权，可以控制设备的哪些数据可以被制造商查看，可以被哪些用户查看等权限

### 1.2 用户管理

组织管理：在物联网平台中一个很重要的观念就是组织，所有的设备，用户，数据都是基于组织的管理的，设备制造商是一个组织，设备的使用者是一个组织，家庭都可以是一个组织。

用户管理：用户是基于一个组织下的人员构成，每个组织下面都有管理员角色，管理员可以为其服务的组织添加不通的用户，并分配每个用户不同的权限。一个用户也可以属于多个不同的组织，并且扮演不同的组织

用户组：一组用户，也是基于组织的用户组管理，同一用户组的用户拥有相同的权限

权限管理：同样是基于组织的权限管理，主要是针对对象级别的权限细分，如设备的浏览权限，可以控制每个用户是否看到这个设备；设备数据浏览权限定义是否可以查看设备的运行数据

### 1.3 数据传输管理

#### 1.3.1 基本格式

数据传输管理，定义针对一类型设备的数据传输协议，基本格式是:

![这里写图片描述](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwOTExMTM1ODEzMjUx?x-oss-process=image/format,png)


每一个设备有厂商唯一的序列号，因为每个制造商有自己的编码格式，固此序列号没有固定格式。

命令码，为此条数据的作用，比如是上传数据，或者服务器下发给设备的命令等，一般采用2位数字编码00~99

数据，此部分是此条报文，所包含的数据部分，每个协议可以定义不同的解析方式，比如服务器在收到数据包后，会根据预先定义好的解析方式解析数据字段，并按照规则存储

#### 1.3.2 数据解析定义

每种设备类型可以定义多条命令，每个命令都有自己不同的解析方式，组织的管理员可以为自己的设备类型定义解析方式

服务器接收到数据后，会自动根据预先定义的解析方式解析数据字段

设备开发者要根据在IOT平台定义的数据格式，自行开发自己设备的解析代码

数据字段都按照HEX方式收发

#### 1.3.3 数据的存储

存储要支持分布式架构，可以为每个设备定义不同的存储位置，在diego iot中数据存储使用mysql数据库，实现不同的设备存储在不同的mysql数据库中
每条数据定义生命周期，在生命结束后，系统将自动删除

### 1.4 数据管理

权限管理，数据的权限在物联网平台中是至关重要，数据属于谁是一个非常重要的概念，只有设备的拥有者才能定义数据可以给谁看

大数据，物联网数据本身就是海量的数据，我们可以借助一些开源的大数据平台来实现数据的可视化分析，只有经过分析的数据才是有价值的数据

数据的导出，用户可以导出数据到本地做分析

### 1.5 设备接入方式

当前有2种接入方式

> 1. **直接接入**：物联网终端设备本身具备联网能力直接接入网络，比如 在设备端加入NB-IOT通信模组，2G通信模组。
> 2. **网关接入**：物联网终端设备本身不具备入网能力，需要在本地组网后，需要统一通过网关再接入到网络。 比如终端设备通过zigbee无线组网，然后各设备数据通过Zigbee网关统一接入到网络里面。常用到本地无线组网技术有Zigbee，Lora,BLE MESH, sub-1GHZ等。

## 2.网络通讯

现在所有的云端的物联网平台和设备之间的通讯，本质上都是建构在TCP/IP协议之上的，只是对数据包的再封装而已，基于此我们可以是用wifi，4g来实现设备和云平台的通讯，不过设备与设备之间的通讯，可以有wifi，Bluetooth，zigbee等，下面介绍几种常用的通讯架构

### 2.1 基于移动3/4G通讯


此架构是最简单的架构，设备就如同我们的手机，基于移动通讯来上网，其主要需要考虑如下几点

**每个设备都需要一个SIM卡，可以到移动服务器商办理专门针对物联网的SIM卡**

数据流量问题，这种架构完全是走数据流量，如果有视频数据，将会产生比较大的流量费用，这都是要考虑的

通讯质量问题，这完全依赖于移动服务商的网络覆盖状况，就如同我们手机一样，在有些环境下是没有信号的，也就没办法收发数据

### 2.2 基于wifi局域网


此种架构，**适合于所有的物联网设备都是运行在一个局部环境中，设备通过wifi或者有线连接到路由器，而由路由器统一连接的物联网服务器**，就如同我们家中装一个wifi路由器上网一样的架构，需要注意的事项：

局域网内的智能设备，是没有公网独立的ip的，只有一个局域网内的ip，带来的问题就是，**设备可以直接给物联网服务器发送数据包，而物联网服务器是不能直接给设备发送数据包，就因为设备没有公网独立ip**

功耗问题，对于使用wifi接入的设备，最好不是电池供电，**因为wifi的功耗比较大**

干扰问题，如果在大型的厂房部署这种架构，一定要考虑，厂房内是否有强干扰源，如电磁干扰，可以考虑采用工业级的无线路由器，一般抗干扰能力比较强

### 2.3 基于蓝牙通讯

一般的基于蓝牙的物联网，会考虑通过蓝牙网关来部署


蓝牙由于其点对点的通讯方式，所以要考虑如下问题：

蓝牙网关的容量问题，也就是一个蓝牙网关能接入几个蓝牙设备，这取决于蓝牙网关中使用了多少个蓝牙设备

蓝牙的配对问题，蓝牙设备直接的通讯都首先配对才能通讯，如果实现自动配对，如果不能自动配对，大规模部署，将是一个很麻烦的事情

还有一种场景是针对不需要一直在线的物联网设备，而只是在某种特殊需求的情况下，需要连上服务器，这种场景下，我们可以通过手机的蓝牙功能来让设备接入物联网


蓝牙手环是这种架构的一种典型应用模式

### 2.4 基于zigbee

ZigBee也是一种流行的组网模式，zigbee本身设计是针对传感器之间的联网，具有非常强的低功耗能力

**zigbee接入网络也依赖于zigbee网关，网关本身也是一个zigbee设备，zigbee设备是自组网的**，在使用过程中注意的问题有

数据量的问题，设备能力和功耗本身是自相矛盾的，**由于ZigBee是超低功耗方案，固在通信能力上也是打折扣的，很适合一些传感器数据的采集，如温度湿度**，但如果对大数据量的视频类的就不适用了

## 3 物联网平台的产品架构

### 3.1 产品架构

物联网平台，提供海量设备的接入与管理能力，可以将您的IoT设备连接到云平台，支撑设备数据采集上云和云端下发命令给设备进行远程控制，根据不同的应用场景，帮助您快速构建物联网安全监测解决方案。

构建一个完整的建物联网安全监测解决方案，主要分为设备、物联网平台、行业应用3个部分：

**1）设备**

即物联网技术中的感知层和网络层。

对于各类传感设备，可以通过zigbee/Lora/RS485等通讯方式接入传感网，或通过4G/5G/NB-IoT/以太网等多种网络接入物联网平台，并使用MQTT协议将业务数据上报到平台，平台也可以将控制命令下发给设备。

**2）物联网平台**

即物联网技术中的平台层。

物联网平台作为承接设备与行业应用的中间服务，它承载了抽象化的业务逻辑及标准化的核心数据模型，实现设备的快速接入，同时提供强大的模块化能力，支撑行业应用场景下的各类需求。

**3）行业应用**

即物联网技术中的应用层，通过调用物联网平台提供的API接口，快速构建满足行业需求的功能模块。

![img](http://image.woshipm.com/wp-files/2021/03/UW8DE30k9ED6kLSupTlz.png)

### 3.2 感知层

感知层，实现对物理世界的识别感知、信息采集，是物理世界和信息世界的重要桥梁。感知层包括RFID、传感器等设备。

**1）RFID（射频识别技术）**

通过一个小小的标签，便拥有信息存储、信息收发的能力，使得每个物体都被赋予了一个ID，为物体识别带来极大的便利。

**2）传感器**

对于传统的定义为：能感受到被测量并按照一定的规则转换成可用输出信号的器件或装置。对于广义上的传感器，在此基础上还会加入微处理器、模数转换、通信模组、电路设计、嵌入式程序等能力，极大程度地提升传感器的智能化。

### 3.3 网络层

网络层，实现数据传输，把数据从感知层传输至平台层。网络层又分为物接入互联网、互联网传输两部分。

#### 3.3.1 物接入互联网部分

分为三类通讯方式：**有线通讯、无线短距局域网通讯、无线长距广域网通讯。**

**1）有线通讯**

- 以太网/光纤；
- 串口通讯：按位（bit）发送和接收字节，如USB/RS485/RS232等。

**2）无线短距局域网通讯**

- ZigBee（紫蜂）：一种低速短距的无线通信技术，工作频段在4GHz，通讯距离在百米范围，功耗低。通过节点+网关的方式，可以搭建万级节点拓扑的私有网络；
- Wifi：一种高速短距的无线通信技术，工作频段在2.4GHz和5GHz，通讯距离在百米范围，功耗很大，一般只用于有源设备；
- Bluetooth（蓝牙）：一种中速短距的无线通信技术，工作频段在4GHz，通讯距离在十米范围，连接设备的数量不多。

**3）无线长距广域网通讯**

- Lora（Long Range Radio）：一种低速远距调制技术，采用线性调制扩频方式，增强通讯距离，可达2~15km的范围，在中国使用的是470-510MHz免授权频段。与ZigBee类似也是需要通过节点+网关的方式搭建网络，功耗较低；
- NB-IoT（Narrow Band Internet of Things，窄带物联网）：一种新兴的低功耗远距通信技术，属于授权频段，只需要180kHz的带宽便可部署至运营商网络上。通讯距离也在10km级别。其低功耗休眠机制，会导致无法实时通信；
- 4G：第四代移动通信技术，高速远距通信，在中国使用的工作频段为824~960 MHz，1710~2690 MHz。传输数据量大，功耗也大。

#### 3.3.2 互联网传输部分

目前有两种主流的通讯协议：MQTT和CoAP

- MQTT（Message Queuing Telemetry Transport，消息队列遥测传输）：是一个基于客户端-服务器的消息发布/订阅传输协议，可保持长连接，实现多对多异步通信；
- CoAP（The Constrained Application Protocol，受限应用协议）：是一种客户端-服务器单对单的协议，具备轻量低功耗的特点。

### 3.4 平台层

![img](http://image.woshipm.com/wp-files/2021/03/kqmZN8Lyu9TtvARA1uR6.png)

上图为设备上平台的数据信息流。对于平台层的各种能力，下面将会展开说明。

#### 3.4.1 产品管理

产品是设备的集合，通常是一组具有相同功能定义的设备集合。该模块以一种硬件产品为粒度，创建产品及配置产品相关信息。

- 产品信息管理：硬件产品的功能描述、性能参数、发布状态等信息管理；
- 组网拓扑管理：对于传感器、采集仪、网关，由于通讯方式不同，产品的组网拓扑便不同。此处描述各类产品入网的拓扑关系；
- 版本&固件管理：对产品的版本信息及固件进行管理；
- 物模型管理：物模型，即一类物理世界的实物（如传感器）在平台的数字化模型。物模型对该产品的上行数据、下行指令，上下行动作进行描述。简单来说，物模型就是该实体能对外提供什么信息以及能对它做什么，因此物模型是设备与平台之间的关键枢纽。

#### 3.4.2 设备管理

设备是硬件产品的最小单位，每个设备都对应一个唯一编码，从设备入库开始便记录相关信息，并且可以对设备进行资产分配、安全认证、配置操作等行为，最后对设备从入库到报废的全生命周期管理。

- 设备全生命周期管理：对设备的物理状态、健康状态、资产归属、调试日志进行记录，记录设备从入库到报废的全生命周期，便于问题追溯分析。
- 设备资产管理：对设备资产进行划分，便于控制用户设备权限。
- 虚拟设备：根据物模型构建虚拟设备，用于用户体验、真实设备受限时的模拟调试验证、批量压测验证平台性能等场景。
- 设备影子：每个设备有且只有一个设备影子，设备可以通过MQTT获取和设置设备影子来同步状态，用于存储设备上报状态、应用程序期望下发的配置，解耦应用于终端设备。一般用于网络不稳定、设备无法实时通信、一个设备在同一时间被反复请求等场景。

#### 3.4.3 IoT设备接入

物联网平台支持海量多元异构数据的设备接入，通过简易的配置，便可建立设备与云平台之间的联系，实现稳定可靠的双向通信。

- 协议接入：使用MQTT协议接入数据，并根据场景定义不同topic进行消息发布订阅。
- 设备鉴权认证：以网关为单位，对接入数据topic做发布订阅鉴权认证，实现topic级别的权限隔离，提高接入安全性。
- 数据转换解析：对接入的异构数据进行格式统一，根据物模型对接入数据进行解析。
- 设备接入配置：此处的目的是把接入到平台的数据与具体的实体对象进行握手，以便于在应用中能够区分不同实体对象的数据。此处依赖于产品物模型与产品组网拓扑。需要注意的是，在应用层中，根据不同业务属性，可能会把实体对象做某些关系映射。
- 消息通信：当完成设备接入配置后，用户便能实现对设备的交互，包括数据上报、命令下发等。

#### 3.4.4 数据展示

该模块对物联网收集的数据，运用相应的可视化图表进行展示，以便于物联网监测数据能直观展示。此处功能与企业业务方向会紧密相关。

- 基础监测数据：对结构化数据进行基础图形表格数据展示。
- 系统集成数据：对视频监控、车流量等系统集成类进行数据展示。
- 数据可视化：安全监测领域主流的可视化系统，如BIM、GIS、视频融合、人员定位、可视化大屏等。
- 数据管理：对原始数据的数据维护、数据下载、文档管理等服务。

#### 3.4.5 数据分析

该模块对展示的数据加以分析，把物联网海量数据变成有价值的数据。此处功能与企业业务方向会紧密相关。

- 基础数据分析：包括同步分析、关联分析、同步分析、频谱分析、风玫瑰图分析；
- 高级数据分析：针对特定传感器的高级算法分析，包括索力算法分析、动态称重分析、深度测斜分析、柱体分析、索承结构分析；
- 报告报表分析：专业结构人员使用的分析工具，制作专业分析报告。

#### 3.4.6 规则引擎

规则引擎是指用户可以在物联网平台上可以配置某些规则，在判断条件满足规则后，平台会执行相应的动作来满足用户需求，灵活构建场景联动、报警等定制化业务场景。规则引擎所需要的元素如下：

**1）触发条件**

- 触发对象：可以是某个设备，某个测点，也可以是某个时刻，或某个事件；
- 触发条件：可以是简单的上下限判断，也可以是一个复杂的函数/算法判断；
- 触发时间：即时效性，可以是一直有效，或者规定时间内有效；
- 沉淀机制：避免设备上传相同数据导致重复触发规则。

**2）执行动作**

- 指令下发：即对制定设备发送指令；
- 发送通知：如短信、邮件、小程序、APP推送等；
- 产生报警：在运维报警监控界面产生一条报警记录；
- 执行时间：立即、或延时；
- 执行规则：执行某条规则；
- 规则状态开关：开启或关闭某条规则。

**3）日志**

每条状态为开启的规则，每次执行都要留有日志，存储触发时间、判断依据、执行动作记录等。

#### 3.4.7 运维服务

此模块为专业运维团队提供运维服务，是业务正常运作的关键。

- 运维监控：对项目运维情况进行监控，包括设备拓扑网络、运维报警监控、无效数据、设备报表分析；
- 设备调试：对设备进行远程在线调试；
- OTA升级：上传新的升级包，并将OTA升级消息推送给设备，设备即可在线升级；
- 日志服务：包括设备全生命周期日志、用户操作日志等；
- 业务工单：支持业务运作的跨部门协作工单，此工单内容根据企业业务不同会有较大差异，此处不做具体展开说明。