---
title: 12.MQTT协议的消息传递可靠性和持续性
date: 2022-04-14 09:44:37
permalink: /mqtt/mkaced9/
categories:
  - MQTT
tags:
  -
---

- [什么是MQTT协议? - 数字基座-观点与实践 (digiinfr.com)](https://blog.digiinfr.com/什么是mqtt协议/)
- [MQTT协议的消息传递可靠性和持续性 - 数字基座-观点与实践 (digiinfr.com)](https://blog.digiinfr.com/mqtt协议的消息传递可靠性和持续性/)

## 1 MQTT架构

MQTT运行在TCP/IP之上，采用PUSH/SUBSCRIBE拓扑结构。在MQTT架构中，有两种类型的系统：客户端和代理。代理就是服务器，用于客户端通信。代理接收来自客户端的通信并将这些通信发送给其他客户端。客户端之间不直接通信，而是连接到代理。每个客户端可以是发布者，也可以是订阅者，或者两者都是。

MQTT是一个事件驱动的协议。没有周期性或持续的数据传输。这使传输保持在最低限度。客户端只有在有信息要发送时才会发布，而代理只有在新数据到达时才会向订阅者发送信息。

![img](https://blog.digiinfr.com/wp-content/uploads/2020/07/MQTT-1.png)

### 1.1 与HTTP协议的对比

|            | HTTP                   | [MQTT](https://blog.digiinfr.com/glossary/mqtt/) |
| ---------- | ---------------------- | ------------------------------------------------ |
| 设计方向   | 以文档为中心           | 以数据为中心                                     |
| 形式       | 请求/响应              | 发布/订阅                                        |
| 传输层协议 | TCP/IP                 | TCP/IP                                           |
| 安全机制   | HTTPS                  | TLS                                              |
| 复杂度     | 相对复杂               | 简单                                             |
| 消息大小   | 大，基于文本描述了内容 | 小，压缩的头信息只占2比特                        |
| 服务等级   | 不区分，所有消息相同   | 3种服务传输等级                                  |
| 数据发布   | 1对1                   | 1对0，1对1，1对多                                |

#### 1.2 性能对比

MQTT以物联网场景的数据传输方面对比HTTP有明显的优势，以下实验数据供参考（[Power Profiling: HTTPS Long Polling vs. MQTT with SSL, on Android](https://stephendnicholas.com/posts/power-profiling-mqtt-vs-https)）：

|                                                  | 每小时耗电量 | 每小时消息量 | 消息传达  |
| ------------------------------------------------ | ------------ | ------------ | --------- |
| **3G环境**                                       |              |              |           |
| HTTPS                                            | 18.43%       | 1708         | 240/1024  |
| [MQTT](https://blog.digiinfr.com/glossary/mqtt/) | 16.13%       | 160278       | 1024/1024 |
| **WIFI**                                         |              |              |           |
| HTTPS                                            | 3.45%        | 2628         | 524/1024  |
| [MQTT](https://blog.digiinfr.com/glossary/mqtt/) | 4.23%        | 263314       | 1024/1024 |

发送1B*1024条消息，尽可能快速的连续发送

另外参考以下实验：[MQTT VS HTTPS PERFORMANCE ON AWS IOT CORE](https://www.green-custard.com/blog/MQTTvsHTTPS)。MQTT的性能优势，只有大量连续数据时才可以体现（比如多个仪表数据的连续传递）。

|                                                     | 尺寸（Bytes） | 发送时间（ms） |
| --------------------------------------------------- | ------------- | -------------- |
| **2B大小的消息发送1次**                             |               |                |
| [MQTT](https://blog.digiinfr.com/glossary/mqtt/) Q0 | 10476         | 143.677        |
| HTTP                                                | 9616          | 87.461         |
| **10B\**大小的\**消息发送10次**                     |               |                |
| [MQTT](https://blog.digiinfr.com/glossary/mqtt/) Q0 | 14605         | 142.41         |
| HTTP                                                | 99000         | 785.981        |
| **50B\**大小的\**消息发送10次**                     |               |                |
| [MQTT](https://blog.digiinfr.com/glossary/mqtt/) Q0 | 28957         | 170.552        |
| HTTP                                                | 113130        | 1008.473       |

## 2 安全机制

MQTT协议的最初目标是在昂贵的、不可靠的通信线路上尽可能地实现最小和最有效的数据传输。因此，在MQTT的设计和实施过程中，安全性并不是首要考虑的问题。

当然，有一些安全选项可供选择，但代价是更多的数据传输量和消耗。

- **网络安全**–如果网络本身够安全，那MQTT数据的传输安全性就不这么重要了。网络内部不会有不安全行为，除非是不良行为者或其他网络渗透。
- **用户名和密码**–MQTT确实允许客户与代理建立连接时使用用户名和密码。不幸的是，用户名和密码是以明文形式传输的。在1999年，这已经绰绰有余，因为拦截卫星通信基本上是一个不重要的传感器读数将是非常困难的。然而，今天，拦截各类无线网络通信都不难，这使得这种认证完全没有用处。 许多用例需要用户名和密码，不是为了防止恶意行为者，而是为了避免无意的连接。
- **SSL/TLS** – 既然运行在TCP/IP之上，通过SSL/TLS的自然是一种可行的方案。但不幸的是，这会给原本轻量级的通信增加了大量的开销。

## 3 了解服务质量(QoS)

MQTT是一个轻量级的协议，但它仍被用于一些要求可靠传递消息的复杂场景中。

客户端可以配置不同级别的服务质量(QoS)，以确保可靠的消息传递。由于它是规范的一部分，所以在标准的MQTT代理应该实现这一功能。

与其他面向服务的环境类似，MQTT中的QoS是代理和客户端之间的协议。当他们双方就特定的QoS级别达成一致时，就隐含着代理履行规定的意思。

MQTT中的QoS有三个级别。

```
QoS 0 最多交付一次。
QoS 1：至少交付一次。
QoS 2：精确一次交付。
```

### 3.1 QoS 0：最多交付一次。

这是客户端和代理使用的默认服务质量水平，它并不能保证消息的传递。在MQTT中，消息的发送取决于网络能力和连接性。用户要确认收到，而发布者不需要重试发送。消息可能会或根本不会到达用户。在网络可靠且偶尔丢失消息可以接受的环境中，QoS 0是首选。例如，当多个温度传感器每10秒发布一次消息时，丢失几个消息不会对系统产生多大影响。

![img](https://blog.digiinfr.com/wp-content/uploads/2020/11/MQTT_QOS0.png)



### 3.2 QoS 1：至少交付一次

这种服务质量确保信息至少一次到达接收方。未确保送达，会重试多轮，订阅者可能多次收到相同的消息。订阅者代理商确认收到消息，代理将停止重试传递。QoS 1用于保证消息交付很重要的场景。接收相同的消息多次（收到重复消息）是可以接受的，但至少应该交付一次。

**该QoS级别配置在定期报告关键设备或系统状态的远程监控场景中。这是最常用的QoS级别。**

![img](https://blog.digiinfr.com/wp-content/uploads/2020/11/MQTT_QOS1.png)

### 3.3 QoS 2：精确地交付一次（不重复）

QoS 2提供了最高的服务质量，在这种情况下，信息的丢失或重复都是不可接受的。它伴随着与可靠服务质量相关的开销增加。虽然这可能是最可靠的QoS，但它也是最慢的。QoS 2应少用于要求保证消息交付的特定客户机。它用于无法承受丢失消息或接收重复消息的关键任务场景。架构师和开发人员在使用QoS 2时应注意性能权衡。 **对于大多数部署，QoS 1就足够了。**

![img](https://blog.digiinfr.com/wp-content/uploads/2020/11/MQTT_QoS2.png)

QoS 2是最安全，但最慢的传输模式。

重要的是要了解每个订阅主题的客户端可以请求不同级别的QoS。MQTT代理可以为订阅同一主题的每个客户端维护不同的QoS级别。由于客户端（发布者和订阅者）在MQTT中是自主的，它们可以独立使用不同的QoS级别。发布者可以使用与订阅者完全不同的QoS级别。

## 4 持久性（Persistence）

尽管MQTT不是一个完整的面向消息的中间件，但它支持消息的持久性。当处理在受限环境中运行的客户端时，这个功能变得至关重要。

每次客户端连接到MQTT代理时，它都会启动一个新的会话来订阅或发布到主题。如果连接丢失，这个过程会重新开始，客户端会建立一个新的会话。这个过程可能会干扰系统的性能，特别是对于那些处理能力低和连接断断续续的客户端。这就是MQTT broker的持久性功能变得有用的地方。

当客户端连接到MQTT代理时，它可以将 “Clean Session “标志设置为false，表示即使客户端断开连接后，MQTT代理也应该保留会话信息。然后，MQTT代理开始为该客户端持久化会话。每个会话都包含详细信息，如客户端订阅或发布的主题、客户端离线时发送的 QoS 1 和 QoS 2 消息，以及客户端尚未确认的 QoS 2 消息。

- QoS 0 消息不持久。消息没有存储在服务器上。如果发布者断开连接，或者服务器发生故障，消息可能会丢失。如果用户在服务器接收发布的消息时已断开连接，则用户可能不会收到消息。
- QoS 1、2 消息是持久性的。消息存储在服务器上，直到消息被发送到消息的所有订阅者。如果消息订阅者请求的QoS需要确认，则消息将被存储，直到收到确认为止。

持久性在确保MQTT代理满足QoS 1和QoS 2方面也起着重要作用。这个功能必须少用，因为它会干扰MQTT代理的性能。

## 5 保留的信息（Retained Messages）

请记住，在MQTT中，客户端是自主的，它不承认对方的存在。这也意味着，当一个用户连接到代理时，它不知道什么时候会收到消息。有许多不是一个发布者向该主题发送消息，或者发布者可能长期离线。

在某些场景下，发布者在连接到代理后，立即与所有新用户分享最后一条消息是有意义的。例如，当一个移动应用（发布者）向多个连接的灯泡（订阅者）发送亮度和颜色值的消息时，它希望新灯泡被设置为相同的值。因此，当一个新的灯泡连接到MQTT代理时，它将收到所有其他灯泡会收到的最后一条消息。这确保了现有订户和新订户的状态是相同的。

## 6 遗嘱（Last Will and Testament-LWT）

客户端突然与代理人断开连接的情况很常见。设备可能失去电源或网络连接，迫使它断开连接。在很多情况下，让其他客户知道某个特定客户突然结束会话可能会有帮助。

MQTT代理提供了一个强大的功能，称为遗嘱(LWT)，它使客户能够主动选择一个主题和消息，当它被断开连接时，将被发布。有兴趣的客户可以订阅LWT主题，当客户被不优雅地断开连接时，他们将立即得到经纪人的通知。

例如，当一个移动应用（发布者）失去连接时，所有被该应用控制的设备都会收到该应用离线的消息。当移动应用获得连接性时，它可以向同一主题发布保留消息，告知客户它已经在线。要知道，LWT话题和消息并不是特殊的，也不是保留的。客户端可以像其他主题一样向它发布消息。

LWT话题和消息提供了一种机制，让所有感兴趣的客户端知道特定客户端的状态。