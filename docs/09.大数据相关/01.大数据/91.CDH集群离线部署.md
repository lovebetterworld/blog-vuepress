---
title: CDH集群离线部署
date: 2022-10-26 09:38:36
permalink: /bigdata/cdh01/
categories: 
  - 大数据
tags: 
  - 大数据
---

- [CDH集群离线部署(CM6.3.1 + CDH6.3.2 + CentOS7)_](https://blog.csdn.net/qq_40856560/article/details/109007683)
- [CDH 6.3.2 离线安装部署详细教程](https://blog.csdn.net/BoomLee/article/details/119119096)
- [CDH6.3.2离线安装（附百度网盘CDH安装包）](https://zhuanlan.zhihu.com/p/366308900)
- [CM6.3.1+CDH6.3.2环境搭建](https://zhuanlan.zhihu.com/p/425449993)
- [CDH6.3.2 详细介绍及使用](https://zhuanlan.zhihu.com/p/428044940)
- [大数据之CDH（web页面部署Hadoop）](https://blog.csdn.net/yanxifaner/article/details/120210259)
- [CDH集群部署最佳实践](https://zhuanlan.zhihu.com/p/72167108)
- [CDH 6.3 大数据平台搭建 ](https://zhuanlan.zhihu.com/p/444565129)
- [CDH6.3.1集群离线部署](https://juejin.cn/post/6844904052698906631)
- [基于阿里云的CDH集群安装_Frank](https://blog.csdn.net/qq_16906867/article/details/127519913)
- [CDH简介及CDH部署、原理和使用介绍( 版本6.3.1 )_](https://blog.csdn.net/wt334502157/article/details/120290580)
- [【手册】CDH6.3.2及hadoop生态圈工具安装部署手册（附带安装包）](https://blog.csdn.net/spark9527/article/details/116757508)
- [大数据之CDH（web页面部署Hadoop）](https://blog.csdn.net/yanxifaner/article/details/120210259)
- [CDH大数据平台搭建之集群规划](https://blog.csdn.net/qq_41924766/article/details/117561341)
- [CDH安装Phoenix(cdh6.2以上版本、镜像包和安装文档)_](https://blog.csdn.net/qq_43016289/article/details/118998355)

## 1 原生Hadoop的问题

1. 版本管理过于混乱
2. 部署过程较为繁琐,升级难度较大
3. 兼容性差
4. 安全性低

## 2 CDH和CM(Cloudera Manager）

1. CDH(Cloudera’s Distribution Including Apache Hadoop),是Hadoop众多分中的一种，由Cloudera公司维护，基于稳定版本的Apache Hadoop构建，并集成了很多补丁，可以直接用于生产环境。就是Hadoop等大数据安装包的第三方版本的集合，提供了Hadoop等大数据服务的安装包。
2. CM(Cloudera Manager)提供了一个管理和监控Hadoop等大数据服务的web界面，能让我们方便安装大数据生态圈的大部分服务。

## 3 Hadoop自动化部署和管理平台

主流的有Apache Ambari和Cloudera Manager，相对应的Hadoop的发行版为HDP和CDH。

这种自动化部署平台的功能一般如下:

1. 提供Hadoop大数据集群
2. 管理Hadoop大数据集群
3. 监控Hadoop大数据集群

PS:HDP的公司(hortonworks)已经被CDH公司(Cloudera)收购了

## 4 Cloudera Manager架构

![img](https://img-blog.csdnimg.cn/20201011090404505.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)



1. Server：负责软件安装、配置，启动和停止服务，管理服务运行的群集。**核心**

2. Agent：安装在每台主机上。负责**启动和停止进程，**配置，监控主机。

3. Management Service：由一组执行各种监控，警报和报告功能角色的服务。**图表的生成和管理**

4. Database：存储配置和监视信息。

5. Cloudera Repository：软件由Cloudera 管理分布存储库。（有点**类似Maven的中心仓库**）；在线安装（从中心仓库拉取）和离线安装（离线库）

6. Clients：是用于与服务器进行交互的接口（API和Admin Console）

## 5 CDH下载

官方下载地址:https://archive.cloudera.com

### 5.1 CM下载

https://archive.cloudera.com/cm6/6.3.1/redhat7/yum/RPMS/x86_64/

![img](https://img-blog.csdnimg.cn/20201011090420512.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)



### 5.2 CDH下载

https://archive.cloudera.com/cdh6/6.3.2/parcels/

![img](https://img-blog.csdnimg.cn/20201011090432419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)

注意:CDH的版本一定要和CM的版本对应

## 6 环境准备

使用VMware模拟多台主机，由于主机条件有限，只演示三台机器，配置如下:

| 主机名 | 系统    | IP             | 内存 | 磁盘 |
| ------ | ------- | -------------- | ---- | ---- |
| cdh-1  | Centos7 | 192.168.100.10 | 4G   | 60G  |
| cdh-2  | Centos7 | 192.168.100.20 | 2G   | 60G  |
| cdh-3  | Centos7 | 192.168.100.30 | 2G   | 60G  |

### 6.1 修改主机名(所有节点)

```bash
hostnamectl set-hostname cdh-1
hostnamectl set-hostname cdh-2
hostnamectl set-hostname cdh-3
```

### 6.2 关闭防火墙(所有节点)

```bash
systemctl stop firewalld
systemctl disable firewalld
```

### 6.3 关闭SELinux(所有节点)

```bash
setenforce 0 #临时关闭
#永久关闭 将SELINUX= enforcing 修改为SELINUX=disabled
vi /etc/selinux/config
SELINUX=disabled 
```

PS: 可以使用

```bash
sed -i s/SELINUX=enforcing/SELINUX=disabled/g /etc/selinux/config
```

### 6.4 配置IP到主机的映射(所有节点)

```bash
vi /etc/hosts
192.168.100.10 cdh-1
192.168.100.20 cdh-2
192.168.100.30 cdh-3
```

### 6.5 配置免密码登录(cdh-1)

```bash
# 生成公钥和私钥 三次回车
ssh-keygen
# 复制公钥和私钥
ssh-copy-id cdh-1
ssh-copy-id cdh-2
ssh-copy-id cdh-3
```

### 6.6 设置用户最大可打开文件数，进程数，内存占用(所有节点)

```bash
vi /etc/security/limits.conf
```

```bash
soft    nofile   32728
hard    nofile   1024999
soft    nproc   65535
hard    noroc    unlimited
soft    memlock    unlimited
hard    memlock    unlimited
```

```bash
sysctl -p
```

### 6.7 设置swap空间(所有节点)

```bash
echo "vm.swappiness = 0" >> /etc/sysctl.conf
```

Cloudera建议将交换空间设置为0，过多的交换空间会引起GC耗时的激增。

### 6.8 关闭大页面压缩(所有节点)

```bash
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag
```

## 7 安装

将下载好的CDH包和CM的包使用sftp上传到cdh-1

### 7.1 配置本地yum

CDH的安装包都是rpm包如果使用rpm安装方式安装起来是比较复杂的，会有很多依赖问题需要解决，就需要使用yum帮助我们解决依赖问题。

![img](https://img-blog.csdnimg.cn/20201011090650551.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)

#### 7.1.1 配置centos源(cdh-1)

```bash
#挂载centos7镜像
mount /dev/cdrom /mnt/
#删除系统自带的源
rm -rf /etc/yum.repos.d/*
#新建一个本地yum源
cat >> /etc/yum.repos.d/local.repo << EOF
[centos]
name=centos
baseurl=file:///mnt
gpgcheck=0
EOF
#验证
yum repolist
```

#### 7.1.2 安装httpd服务（cdh-1）

```bash
# 安装
yum install -y httpd
# 启动
systemctl start httpd
#开机自启
systemctl enable httpd
```

http服务可以帮助我们传输文件，默认静态资源的目录为/var/www/html

#### 7.1.2 centos源配置为http方式获取（cdh-1）

```bash
#在http服务的静态资源目录创建centos目录
mkdir /var/www/html/centos
#将centos的镜像文件复制到centos目录
cp -rvf /mnt/* /var/www/html/centos/
#可以通过http访问了
http://192.168.100.10/centos/
#修改cdh-1的本地centos源的配置
vi /etc/yum.repos.d/local.repo
baseurl=http://cdh-1/centos
#取消挂载
umount /dev/cdrom /mnt
```

其他节点配置(cdh-1,cdh-2)

```bash
cat >> /etc/yum.repos.d/local.repo << EOF
[centos]
name=centos
baseurl=http://cdh-1/centos
gpgcheck=0
EOF
#验证
yum repolist
```

#### 7.1.3 配置CM源

1. 移动文件安装包文件到http服务器静态文件目录(cdh-1)

```bash
#在/var/www/html创建存放cm包的文件夹和cdh安装包的文件夹
mkdir /var/www/html/{cm,cdh}
#将cdh的安装包和cm的包移动到创建的目录
#移动cm安装包
mv cloudera-manager-* /var/www/html/cm/
mv  enterprise-debuginfo-6.3.1-1466458.el7.x86_64.rpm oracle-j2sdk1.8-1.8.0+update181-1.x86_64.rpm /var/www/html/cm
#移动cdh安装包和元数据文件
mv CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel manifest.json /var/www/html/cdh/
```

2. 制作CM源生成repodata文件，需要用到createrepo这个包(cdh-1)

```bash
#安装
yum install -y createrepo
#进入到cm的rpm包存放目录
cd /var/www/html/cm
# 生成repodata文件夹
createrepo .
```

3. 配置yum源（所有节点）

```bash
cat >> /etc/yum.repos.d/cm.repo << EOF
[CM]
name=cm
baseurl=http://cdh-1/cm/
gpgcheck=0
EOF
```

### 7.2 安装

![img](https://img-blog.csdnimg.cn/20201011090730501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)

#### 7.2.1 安装依赖(所有节点)

```bash
yum install -y bind-utils libxslt cyrus-sasl-plain cyrus-sasl-gssapi portmap fuse-libs /lib/lsb/init-functions httpd mod_ssl openssl-devel python-psycopg2 Mysql-python fuse
```

#### 7.2.2 安装Cloudera Manager和Cloudera Agent(cdh-1)

```bash
#安装JDK
yum install -y oracle-j2sdk1.8.x86_64
#安装cloudera-manager
yum install  -y cloudera-manager-agent cloudera-manager-daemons cloudera-manager-server cloudera-manager-server-db-2 postgresq-server
```

#### 7.2.3 安装Mariadb

```bash
#安装
yum install -y mariadb-server
#启动和开机自启
systemctl start mariadb && systemctl enable mariadb
#配置Mariadb数据库
mysql_secure_installation
```

![img](https://img-blog.csdnimg.cn/20201011090751784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODU2NTYw,size_16,color_FFFFFF,t_70)

#### 7.2.4 初始化管理节点(cdh-1)

1. 复制mysql的jdbc驱动包到/usr/share/java目录

需要使用sftp上传jar包到cdh-1节点上

```bash
#创建/usr/share/java目录
mkdir -p /usr/share/java
#复制jar包到/usr/share/java下
cp mysql-connector-java-5.1.48.jar /usr/share/java/
#注意:需要改名为mysql-connector-java.jar
mv /usr/share/java/mysql-connector-java-5.1.48.jar /usr/share/java/mysql-connector-java.jar
```

2. 初始化数据库

```bash
/opt/cloudera/cm/schema/scm_prepare_database.sh mysql -h localhost -uroot -proot --scm-host localhost scm root root
```

#### 7.2.5 安装agent节点

只需要在chd-2和cdh-3节点上安装

```bash
#安装jdk
yum install -y oracle-j2sdk1.8.x86_64
#安装agent
yum install cloudera-manager-daemons cloudera-manager-agent -y
```

#### 7.2.6 修改配置文件(所有节点)

修改Cloudera Agent配置文件/etc/cloudera-scm-agent/config.ini，配置server_host为主节点cdh-1

```bash
#通过vi命令修改
vi /etc/cloudera-scm-agent/config.ini
server_host=cdh-1
#也可以通过sed命令修改
sed -i "s/server_host=localhost/server_host=cdh-1/g" /etc/cloudera-scm-agent/config.ini
注意:只用使用一种命令修改就行了，推荐使用sed
```

#### 7.2.7 配置JAVA_HOME(所有节点)

```bash
vi /etc/profile
```

```bash
export JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera/
export PATH=$PATH:$JAVA_HOME/bin
```

### 7.3 启动

#### 7.3.1 启动Cloudera Manager(cdh-1)

在主节点启动Cloudera Manager

```bash
#启动
systemctl start cloudera-scm-server
#设置开机自启
systemctl enable cloudera-scm-server
```

#### 7.3.2 启动Cloudera Agent(所有节点)

```bash
#启动
systemctl start cloudera-scm-agent
#开机自启
systemctl enable cloudera-scm-agent
```

可以访问http://192.168.100.10:7180 用户名密码都是admin

## 9 问题记录

### 9.1 CDH环境HDFS权限问题

- [ CDH环境HDFS权限问题](https://blog.csdn.net/lingeio/article/details/97763315)

CDH环境下Hadoop平台最高权限用户是hdfs，属于supergroup组。默认HDFS会开启权限认证，所以操作时，需要将root用户切换到hdfs用户，否则会报错。

```bash
# Linux下默认是没有supergroup组的
# hadoop:x:994:hdfs,mapred,yarn
cat /etc/group
 
# 查看hdfs用户的组是hadoop
# hdfs:x:995:992:Hadoop HDFS:/var/lib/hadoop-hdfs:/sbin/nologin
cat /etc/passwd
```

所以，先在Linux添加supergroup组，把root用户添加到supergroup里，再同步权限到HDFS。

```bash
# Linux添加supergroup组
# supergroup:x:1003:
groupadd supergroup
 
# 将root添加到supergroup
# supergroup:x:1003:root
usermod -a -G supergroup root
 
# 同步系统权限信息到HDFS,会自动同步其他节点权限
# Refresh user to groups mapping successful for cdh-master/192.168.100.45:8020
# Refresh user to groups mapping successful for cdh-slave01/192.168.100.46:8020
su - hdfs -s /bin/bash -c "hdfs dfsadmin -refreshUserToGroupsMappings"
```

### 9.2 CDH server无法检测到agent的问题

- [CDH server无法检测到agent的问题 - 呢喃的歌声 - 博客园 (cnblogs.com)](https://www.cnblogs.com/yaohaitao/p/14106909.html)

搭建CDH集群已经挺多套了，在搭建CDH时候出现server无法检测到agent的问题大概可以这么解决:

1. IP,hostname问题这两个需要认真搭配，一旦IP hostname出现错误或者安装一半机器出问题，解决办法就是删除agent在mysql生成的元数据,具体操作如下（要分为server出问题还是agent出问题,如果都出问题就一起解决）

2. 删除Agent节点的UUID `# rm -rf /opt/cm-5.10.0/lib/cloudera-scm-agent/*` （删除agnet自动生成ID文件）

3. 清空主节点CM数据库 进入主节点的Mysql数据库，然后`drop database cm;` （删除agnet自动生成ID和数据库文件）

4. 在主节点上重新初始化CM数据库`# /opt/cm-5.10.0/share/cmf/schema/scm_prepare_database.sh mysql cm -hSERVERHOSTIP -uroot -pxxx --scm-host SERVERHOSTIP scm scm sc`

### 9.3 修改CDH的HostName和IP

- [修改CDH的HostName和IP_SunnyRivers的博客-CSDN博客](https://blog.csdn.net/Android_xue/article/details/103911264)

### 9.4 修改CM Server的元数据

- [修改CDH的HostName和IP_SunnyRivers的博客-CSDN博客](https://blog.csdn.net/Android_xue/article/details/103911264)

我当时使用的是mysql数据库，因此先登录mysql数据库

- 切换数据库

```sql
use cm;
```

- 查看几个重要字段

```sql
select host_id, host_identifier, name, ip_address  from HOSTS;
```

结果大概如下：

```sql
+---------+--------------------------------------+---------------+--------------+
| host_id | host_identifier                      | name          | ip_address   |
+---------+--------------------------------------+---------------+--------------+
|       1 | 1134ea20-6039-4ac7-b5e3-7a67d556f20e | Utility01     | 10.169.xx.xxx  |
|       2 | 50d9ad8b-d858-45ae-b727-9764eaf347d9 | slave05       | 10.169.xx.xxx |
...
...
|      20 | 59be2b8f-7103-4a40-b623-241c87402e29 | INSIDE-PHY349 | 10.169.xx.xxx  |
```

我们现在就是要把name为 INSIDE-PHY349 的节点，修改为master01

- 修改hostname

```sql
update HOSTS set name='master01' where host_id=20;
```

- 启动CM和集群即可

如果要修改ip，也是类似的

### 9.5 CDH server启动失败

- [解决 CDH6 启动 cloudera-scm-server 失败问题 - 钇钛网 (yourtion.com)](https://blog.yourtion.com/fix-cloudera-scm-server-start-failed.html)

通过命令`journalctl -xe`发现了一些端倪，提示`JAVA_HOME`找不到，但是我明明已经安装过了jdk，使用`java -version`也可以正常列出版本信息，怎么还会找不到呢？之后在一个脚本文件中找到了些答案，原来程序默认会去使用`/usr/java`下的jdk，所以解决办法执行以下两条命令即可：

```bash
mkdir -p /usr/java
ln -s /opt/java/  /usr/java/default
```

