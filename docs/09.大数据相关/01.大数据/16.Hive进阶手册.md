---
title: Hiveè¿›é˜¶æ‰‹å†Œ
date: 2022-10-26 09:36:34
permalink: /bigdata/Hive02/
categories: 
  - Hive
tags: 
  - Hive
---

æ•°æ®åº“å’Œæ•°ä»“åŒºåˆ«

|                | DW                                                           | æ•°æ®åº“                                                       |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ç”¨é€”           | ä¸“é—¨ä¸ºæ•°æ®åˆ†æè®¾è®¡çš„ï¼Œæ¶‰åŠè¯»å–å¤§é‡æ•°æ®ä»¥äº†è§£æ•°æ®ä¹‹é—´çš„å…³ç³»å’Œè¶‹åŠ¿ | ç”¨äºæ•è·å’Œå­˜å‚¨æ•°æ®                                           |
| ç‰¹æ€§           | æ•°æ®ä»“åº“                                                     | äº‹åŠ¡æ•°æ®åº“                                                   |
| é€‚åˆçš„å·¥ä½œè´Ÿè½½ | åˆ†æã€æŠ¥å‘Šã€å¤§æ•°æ®                                           | äº‹åŠ¡å¤„ç†                                                     |
| æ•°æ®æº         | ä»å¤šä¸ªæ¥æºæ”¶é›†å’Œæ ‡å‡†åŒ–çš„æ•°æ®                                 | ä»å•ä¸ªæ¥æºï¼ˆä¾‹å¦‚äº‹åŠ¡ç³»ç»Ÿï¼‰æ•è·çš„æ•°æ®                         |
| æ•°æ®æ•è·       | æ‰¹é‡å†™å…¥æ“ä½œé€šè¿‡æŒ‰ç…§é¢„å®šçš„æ‰¹å¤„ç†è®¡åˆ’æ‰§è¡Œ                     | é’ˆå¯¹è¿ç»­å†™å…¥æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå› ä¸ºæ–°æ•°æ®èƒ½å¤Ÿæœ€å¤§ç¨‹åº¦åœ°æé«˜äº‹åŠ¡ååé‡ |
| æ•°æ®æ ‡å‡†åŒ–     | éæ ‡å‡†åŒ–schemaï¼Œä¾‹å¦‚æ˜Ÿå‹Schemaæˆ–é›ªèŠ±å‹schema                 | é«˜åº¦æ ‡å‡†åŒ–çš„é™æ€schema                                       |
| æ•°æ®å­˜å‚¨       | ä½¿ç”¨åˆ—å¼å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯å®ç°è½»æ¾è®¿é—®å’Œé«˜é€ŸæŸ¥è¯¢æ€§èƒ½         | é’ˆå¯¹åœ¨å•è¡Œå‹ç‰©ç†å—ä¸­æ‰§è¡Œé«˜ååé‡å†™å…¥æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–           |
| æ•°æ®è®¿é—®       | ä¸ºæœ€å°åŒ–I/Oå¹¶æœ€å¤§åŒ–æ•°æ®ååé‡è¿›è¡Œäº†ä¼˜åŒ–                      | å¤§é‡å°å‹è¯»å–æ“ä½œ                                             |

## 1 Hiveä¸­çš„æ•°æ®åˆ†å±‚

- [Hiveä¸­çš„ODSã€ DWDã€ DWSã€ ADS æ•°ä»“åˆ†å±‚](https://www.cnblogs.com/zyp0519/p/15353930.html)

æ•°ä»“-ODSå±‚ï¼š

1ï¼‰ä¿æŒæ•°æ®åŸè²Œä¸åšä»»ä½•ä¿®æ”¹ï¼Œèµ·åˆ°å¤‡ä»½æ•°æ®çš„ä½œç”¨ã€‚

2ï¼‰æ•°æ®é‡‡ç”¨LZOå‹ç¼©ï¼Œå‡å°‘ç£ç›˜å­˜å‚¨ç©ºé—´ã€‚100Gæ•°æ®å¯ä»¥å‹ç¼©åˆ°10Gä»¥å†…ã€‚

3ï¼‰åˆ›å»ºåˆ†åŒºè¡¨ï¼Œé˜²æ­¢åç»­çš„å…¨è¡¨æ‰«æï¼Œåœ¨ä¼ä¸šå¼€å‘ä¸­å¤§é‡ä½¿ç”¨åˆ†åŒºè¡¨ã€‚

4ï¼‰åˆ›å»ºå¤–éƒ¨è¡¨ã€‚åœ¨ä¼ä¸šå¼€å‘ä¸­ï¼Œé™¤äº†è‡ªå·±ç”¨çš„ä¸´æ—¶è¡¨ï¼Œåˆ›å»ºå†…éƒ¨è¡¨å¤–ï¼Œç»å¤§å¤šæ•°åœºæ™¯éƒ½æ˜¯åˆ›å»ºå¤–éƒ¨è¡¨ã€‚

ç†è®ºä¸Šä¸€èˆ¬åˆ†ä¸ºä¸‰ä¸ªå±‚ï¼š**ODSæ•°æ®è¿è¥å±‚ã€DWæ•°æ®ä»“åº“å±‚ã€ADSæ•°æ®æœåŠ¡å±‚**ã€‚åŸºäºè¿™ä¸ªåŸºç¡€åˆ†å±‚ä¹‹ä¸Šï¼Œå†æäº¤ä¿¡æ¯çš„å±‚æ¬¡ï¼Œæ¥æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚

1. åŸå§‹æ•°æ®æ‹‰å–è¿‡æ¥ï¼Œä¿æŒå’Œå…ƒæ•°æ®åŒæ­¥ï¼Œä¸åšå¤„ç†å½¢æˆODSå±‚ï¼›

2. åŸºäºODSå±‚ï¼Œä¿æŒæ•°æ®åŸå§‹ç²’åº¦ï¼Œå¯¹æ•°æ®åŠ å·¥å’Œå¤„ç†ï¼ˆä¹Ÿå°±æ˜¯æ¸…æ´—ï¼‰ï¼Œæä¾›å¹²å‡€çš„æ•°æ®ä½œDWDå±‚ï¼›

3. æ ¹æ®ODSå’ŒDWDå±‚æ•°æ®ï¼Œè¿›è¡Œè½»åº¦æ±‡æ€»ï¼Œä¿ç•™è¾ƒå¤šç»´åº¦ï¼Œå½¢æˆDWMå±‚ï¼›

4. åŸºäºä»¥ä¸Šæ‰€æœ‰DWå±‚æ•°æ®ï¼Œè¿›è¡Œé«˜åº¦æ±‡æ€»ï¼Œå½¢æˆDWSå±‚ã€‚

### 1.1 æ•°æ®è¿è¥å±‚ï¼ˆODSï¼‰:åŸå§‹æ•°æ®

ODSï¼šOperation Data Store æ•°æ®å‡†å¤‡åŒºï¼Œä¹Ÿç§°ä¸º**è´´æºå±‚**ã€‚æ•°æ®ä»“åº“æºå¤´ç³»ç»Ÿçš„æ•°æ®è¡¨é€šå¸¸ä¼š**åŸå°ä¸åŠ¨**çš„å­˜å‚¨ä¸€ä»½ï¼Œç§°ä¸ºODSå±‚ï¼Œæ˜¯åç»­æ•°æ®ä»“åº“åŠ å·¥æ•°æ®çš„æ¥æºã€‚

ODSå±‚æ•°æ®çš„æ¥æºæ–¹å¼ï¼š

1. ä¸šåŠ¡åº“ : ç»å¸¸ä¼šä½¿ç”¨sqoopæ¥æŠ½å–ï¼Œä¾‹å¦‚æ¯å¤©å®šæ—¶æŠ½å–ä¸€æ¬¡ã€‚å®æ—¶æ–¹é¢ï¼Œå¯ä»¥è€ƒè™‘ç”¨canalç›‘å¬mysqlçš„binlogï¼Œå®æ—¶æ¥å…¥å³å¯ã€‚
2. åŸ‹ç‚¹æ—¥å¿— : æ—¥å¿—ä¸€èˆ¬ä»¥æ–‡ä»¶çš„å½¢å¼ä¿å­˜ï¼Œå¯ä»¥é€‰æ‹©ç”¨flumeå®šæ—¶åŒæ­¥ã€‚å¯ä»¥ç”¨spark streamingæˆ–è€…Flinkæ¥å®æ—¶æ¥å…¥
3. æ¶ˆæ¯é˜Ÿåˆ—ï¼šå³æ¥è‡ªActiveMQã€Kafkaçš„æ•°æ®ç­‰ã€‚

### 1.2 æ•°æ®ä»“åº“å±‚ï¼ˆDWï¼‰ï¼šæ•°æ®æ¸…æ´—,å»ºæ¨¡

**DWæ•°æ®åˆ†å±‚ï¼Œç”±ä¸‹åˆ°ä¸Šä¸ºDWDï¼ˆæ•°æ®æ˜ç»†å±‚ï¼‰ï¼ŒDWMï¼ˆæ•°æ®ä¸­é—´å±‚ï¼‰ï¼ŒDWSï¼ˆæ•°æ®æœåŠ¡å±‚ï¼‰ã€‚ä» ODS å±‚ä¸­è·å¾—çš„æ•°æ®æŒ‰ç…§ä¸»é¢˜å»ºç«‹å„ç§æ•°æ®æ¨¡å‹ã€‚è¿™ä¸€å±‚å’Œç»´åº¦å»ºæ¨¡ä¼šæœ‰æ¯”è¾ƒæ·±çš„è”ç³»ã€‚**

1> DWDï¼šdata warehouse details ç»†èŠ‚æ•°æ®å±‚ï¼Œæ˜¯ä¸šåŠ¡å±‚ä¸æ•°æ®ä»“åº“çš„éš”ç¦»å±‚ã€‚ä¸»è¦å¯¹ODSæ•°æ®å±‚åšä¸€äº›æ•°æ®æ¸…æ´—å’Œè§„èŒƒåŒ–çš„æ“ä½œã€‚ï¼ˆä¾ä¼ä¸šä¸šåŠ¡éœ€æ±‚ï¼‰æ•°æ®æ¸…æ´—ï¼šå»é™¤ç©ºå€¼ã€è„æ•°æ®ã€è¶…è¿‡æé™èŒƒå›´çš„ã€‚

è¿™ä¸€å±‚ä¸»è¦æ˜¯ä¿è¯æ•°æ®çš„è´¨é‡å’Œå®Œæ•´ï¼Œæ–¹ä¾¿åç»­å±‚ä¸­ç‰¹å¾åˆ†æ

2> DWMï¼šä¹Ÿæœ‰çš„ç§°ä¸ºDWBï¼ˆdata warehouse baseï¼‰ æ•°æ®åŸºç¡€å±‚ï¼Œå¯¹æ•°æ®è¿›è¡Œè½»åº¦èšåˆï¼Œå­˜å‚¨çš„æ˜¯å®¢è§‚æ•°æ®ï¼Œä¸€èˆ¬ç”¨ä½œä¸­é—´å±‚ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å¤§é‡æŒ‡æ ‡çš„æ•°æ®å±‚ã€‚

è¿™é‡Œæœ€å®¹æ˜“ææ··ï¼Œå®é™…ç”Ÿäº§ä¸­ç”šè‡³è·³è¿‡è¿™ä¸ªï¼Œåªæœ‰dwdå’Œdwså±‚ï¼Œå…¶å®ä¸¥æ ¼è¦æ±‚ä¸Šæ¥è®²ï¼Œdwdå±‚æ•°æ®æ¥æºäºç”Ÿäº§ç³»ç»Ÿï¼Œåªå¯¹æ•°æ®è´Ÿè´£ï¼Œåˆ«çš„ä¸è€ƒè™‘ã€‚è€Œåˆ°äº†dwmå±‚ï¼Œå·²ç»å¼€å§‹å‘æˆ‘ä»¬çš„ä¸šåŠ¡å±‚é æ‹¢ï¼Œè¦æ ¹æ®æ•°æ®æ¥è¿›è¡Œåˆ†æå’Œè½»åº¦èšåˆï¼Œè¿›è¡Œç»†ç²’åº¦ç»Ÿè®¡å’Œæ²‰æ·€ã€‚

3> DWSï¼šdata warehouse service æ•°æ®æœåŠ¡å±‚ï¼ŒåŸºäºDWBä¸Šçš„åŸºç¡€æ•°æ®ï¼Œæ•´åˆæ±‡æ€»æˆåˆ†ææŸä¸€ä¸ªä¸»é¢˜åŸŸçš„æœåŠ¡æ•°æ®å±‚ï¼Œä¸€èˆ¬æ˜¯å®½è¡¨ã€‚æŒ‰ç…§ä¸šåŠ¡è¿›è¡Œåˆ’åˆ†ï¼šæµé‡ã€ç”¨æˆ·ã€è®¢å•....ç”¨äºæä¾›åç»­çš„ä¸šåŠ¡æŸ¥è¯¢ï¼ŒOLAPåˆ†æï¼Œæ•°æ®åˆ†å‘ç­‰ã€‚

åœ¨è¿™ä¸€å±‚æˆ‘ä»¬è¿˜ä¼šå»ºç«‹ç»´åº¦æ¨¡å‹ï¼Œå¸¸è§çš„æœ‰é›ªèŠ±æ¨¡å‹å’Œæ˜Ÿå‹æ¨¡å‹ã€‚ç»´åº¦å»ºæ¨¡ä¸€èˆ¬æŒ‰ç…§ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

1. é€‰æ‹©ä¸šåŠ¡è¿‡ç¨‹ 2. å£°æ˜ç²’åº¦ 3. ç¡®å®šç»´åº¦ 4. ç¡®å®šäº‹å®ã€‚

è¿™ä¸€å±‚ä¸»è¦å¯¹ODS/DWDå±‚æ•°æ®åšä¸€äº›æ±‡æ€»ã€‚æˆ‘ä»¬å¸Œæœ›80%çš„ä¸šåŠ¡éƒ½èƒ½é€šè¿‡æˆ‘ä»¬çš„DWSå±‚è®¡ç®—ï¼Œè€Œä¸æ˜¯ODSã€‚

### 1.3 æ•°æ®æœåŠ¡å±‚/åº”ç”¨å±‚ï¼ˆADSï¼‰ï¼šå‡ºæŠ¥è¡¨

ADSï¼šapplicationData Serviceåº”ç”¨æ•°æ®æœåŠ¡ï¼Œè¯¥å±‚ä¸»è¦æ˜¯æä¾›æ•°æ®äº§å“å’Œæ•°æ®åˆ†æä½¿ç”¨çš„æ•°æ®ï¼Œä¸€èˆ¬ä¼šå­˜å‚¨åœ¨ESã€mysqlç­‰ç³»ç»Ÿä¸­ä¾›çº¿ä¸Šç³»ç»Ÿä½¿ç”¨ã€‚

æˆ‘ä»¬é€šè¿‡è¯´çš„æŠ¥è¡¨æ•°æ®ï¼Œæˆ–è€…è¯´é‚£ç§å¤§å®½è¡¨ï¼Œä¸€èˆ¬å°±æ”¾åœ¨è¿™é‡Œã€‚

## 2 Hiveæ•°æ®å‹ç¼©

- [ã€Hiveã€‘å»ºè¡¨æ—¶çš„å­˜å‚¨æ ¼å¼](https://blog.csdn.net/hyj_king/article/details/126776080)

Hive åœ¨å¤„ç†æ•°æ®æ—¶ï¼Œä¸€èˆ¬éƒ½éœ€è¦ç»å†æ–‡ä»¶è¯»å–å’Œæ–‡ä»¶å†™å‡ºçš„è¿‡ç¨‹ï¼Œå¦‚æœæŒ‰ç…§åŸæ–‡ä»¶çš„å¤§å°è¿›è¡Œè¯»å†™å’Œä¼ è¾“ï¼Œä¸ä»…æ•ˆç‡æŸ¥è€Œä¸”å¸¦å®½çš„å ç”¨ä¹Ÿå¾ˆé«˜ï¼Œæ­¤æ—¶å°±éœ€è¦æˆ‘ä»¬è¿™é‡Œæ‰€è®²çš„ `å­˜å‚¨æ ¼å¼` å’Œ `å‹ç¼©ç®—æ³•`

### 2.1 ä¸åŒçš„å­˜å‚¨æ ¼å¼+å‹ç¼©ç®—æ³•æ€§èƒ½æ¯”è¾ƒ

æ–‡ä»¶å­˜å‚¨æ ¼å¼ä¸åŒå¯¹åº”ä¸åŒçš„å‹ç¼©ç®—æ³•ï¼Œä»è€Œå¸¦æ¥ä¸åŒçš„æ€§èƒ½ï¼Œæˆ‘ä»¬æ ¹æ®å®é™…ä½¿ç”¨è€ƒè™‘å‹ç¼©ç®—æ³•çš„æ€§èƒ½ï¼Œä¸»è¦é€šè¿‡ä»¥ä¸‹ 3 ä¸ªæŒ‡æ ‡ï¼š

**â‘  å‹ç¼©æ¯”**

å‹ç¼©æ¯”è¶Šé«˜ï¼Œå‹ç¼©åæ–‡ä»¶è¶Šå°ï¼Œæ‰€ä»¥å‹ç¼©æ¯”è¶Šé«˜è¶Šå¥½ï¼›

å‹ç¼©æ¯”è¶Šé«˜ï¼Œå­˜å‚¨ç£ç›˜ç©ºé—´å ç”¨è¶Šå°ï¼Œå¯ä»¥é™ä½å•èŠ‚ç‚¹çš„ç£ç›˜IOï¼ŒåŒæ—¶å¯ä»¥å‡å°‘å ç”¨çš„å¸¦å®½ï¼›

**â‘¡ å‹ç¼©æ—¶é—´**

è¶Šå¿«è¶Šå¥½ï¼ŒåŠ å¿«æ•°æ®åœ¨Hadoopé›†ç¾¤æµåŠ¨çš„é€Ÿåº¦å’Œç£ç›˜ `IO` çš„é€Ÿåº¦

**â‘¢ å‹ç¼©åçš„æ–‡ä»¶æ˜¯å¦å¯ä»¥å†åˆ†å‰²**

å¯ä»¥åˆ†å‰²çš„æ ¼å¼å…è®¸å•ä¸€æ–‡ä»¶ç”±å¤šä¸ªMapperç¨‹åºå¤„ç†ï¼Œå¯ä»¥æ›´å¥½çš„å¹¶è¡ŒåŒ–

| å‹ç¼©æ–¹å¼ | å‹ç¼©æ¯” | å‹ç¼©é€Ÿåº¦ | è§£å‹ç¼©é€Ÿåº¦ | æ˜¯å¦å¯åˆ†å‰² |
| -------- | ------ | -------- | ---------- | ---------- |
| gzip     | 13.4%  | 21 MB/s  | 118 MB/s   | å¦         |
| bzip2    | 13.2%  | 2.4MB/s  | 9.5MB/s    | æ˜¯         |
| lzo      | 20.5%  | 135 MB/s | 410 MB/s   | æ˜¯         |
| snappy   | 22.2%  | 172 MB/s | 409 MB/s   | å¦         |

### 2.2 HIVE ä¸­å¸¸ç”¨çš„å­˜å‚¨æ ¼å¼å¯¹æ¯”

| å­˜å‚¨æ ¼å¼                  | æ˜¯å¦é»˜è®¤ | å­˜å‚¨æ–¹å¼                     | å‹ç¼©ç®—æ³•                            |
| ------------------------- | -------- | ---------------------------- | ----------------------------------- |
| TextFile                  | æ˜¯       | è¡Œå¼å­˜å‚¨                     | Gzipã€Bzip2                         |
| SequenceFile              | å¦       | è¡Œå¼å­˜å‚¨                     | NONEã€RECORDã€BLOCK                 |
| Parquet                   | å¦       | åˆ—å¼å­˜å‚¨                     | Uncompress(é»˜è®¤)ã€Snappyã€Gzipã€Lzo |
| RCFile                    | å¦       | æ•°æ®æŒ‰è¡Œåˆ†å—ï¼Œæ¯å—æŒ‰åˆ—å­˜å‚¨   | -                                   |
| ORCFile(RCFileçš„è¿›åŒ–ç‰ˆæœ¬) | å¦       | æ•°æ®æŒ‰è¡Œåˆ†å—ï¼Œæ¯å—æŒ‰ç…§åˆ—å­˜å‚¨ | NONEã€ZLIB(é»˜è®¤)ã€SNAPPY            |

| å­˜å‚¨æ–¹å¼ | è¡ŒæŸ¥è¯¢æ•ˆç‡ | åˆ—æŸ¥è¯¢æ•ˆç‡ | å‹ç¼©æ•ˆç‡ |
| -------- | ---------- | ---------- | -------- |
| è¡Œå¼å­˜å‚¨ | é«˜         | ä½         | ä½       |
| åˆ—å¼å­˜å‚¨ | ä½         | é«˜         | é«˜       |

### 2.3 TEXTFILE

HIVE ä¸­é»˜è®¤çš„å­˜å‚¨æ ¼å¼ï¼›

ä¸€èˆ¬ä½¿ç”¨åœ¨æ•°æ®è´´æºå±‚(ODS æˆ– STG) ï¼Œé’ˆå¯¹éœ€è¦ä½¿ç”¨è„šæœ¬ LOAD åŠ è½½æ•°æ®åˆ° HIVE æ•°ä»“è¡¨ä¸­çš„æƒ…å†µï¼›

æ•°æ®å­˜å‚¨æ—¶ä¸å‹ç¼©ï¼Œå› æ­¤ç£ç›˜çš„å¼€é”€å’Œæ•°æ®è§£æå¼€é”€æ¯”è¾ƒå¤§ï¼›

TEXTFILE å¯ä»¥ç»“åˆ Gzipã€Bzip2 ç­‰å‹ç¼©ç®—æ³•ä½¿ç”¨(ç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥ï¼Œæ‰§è¡ŒæŸ¥è¯¢æ—¶è‡ªåŠ¨è§£å‹)ï¼Œä½†ä½¿ç”¨è¿™ç§æ–¹å¼ï¼ŒHIVE ä¸ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œä»è€Œæ— æ³•å¯¹æ•°æ®è¿›è¡Œå¹¶è¡Œæ“ä½œï¼›

åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¿…é¡»é€ä¸ªå­—ç¬¦åˆ¤æ–­æ˜¯ä¸æ˜¯åˆ†éš”ç¬¦å’Œè¡Œç»“æŸç¬¦ï¼Œå› æ­¤ååºåˆ—åŒ–å¼€é”€ä¼šæ¯” `SequenceFile` é«˜å‡ åå€ï¼›

å¯ä»¥ç›´æ¥é€šè¿‡ `LOAD` çš„æ–¹å¼ä»æ–‡ä»¶ä¸­åŠ è½½æ•°æ®åˆ° `HIVE` è¡¨ä¸­ï¼›

```sql
--- å¯ä»¥ä¸æŒ‡å®šå­˜å‚¨æ ¼å¼,é»˜è®¤ä½¿ç”¨ TEXTFILE
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†',
   user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
STORED AS TEXTFILE
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
```

å½“ç”¨æˆ·çš„æ•°æ®æ–‡ä»¶æ ¼å¼ä¸èƒ½è¢«å½“å‰ `HIVE` æ‰€è¯†åˆ«çš„æ—¶å€™ï¼Œå¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶æ ¼å¼

é€šè¿‡å®ç° `inputformat` å’Œ `outputformat` æ¥è‡ªå®šä¹‰è¾“å…¥è¾“å‡ºæ ¼å¼

```sql
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†',
   user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
STORED AS 
INPUTFORMAT  'org.apache.hadoop.mapred.TextInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat'
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
```

### 2.4 SEQUENCE FILE

HADOOP API æä¾›çš„ä¸€ç§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥ `key-value` çš„å½¢å¼åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ï¼›

æ”¯æŒåˆ‡ç‰‡ï¼›

æ•°æ®åŠ è½½å¯¼å…¥æ–¹å¼å¯ä»¥é€šè¿‡INSERTæ–¹å¼åŠ è½½æ•°æ®ï¼›

```sql
--- å¯ä»¥ä¸æŒ‡å®šå­˜å‚¨æ ¼å¼,é»˜è®¤ä½¿ç”¨ TEXTFILE
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
STORED AS SEQUENCEFILE
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
;

CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
STORED AS 
STORED AS 
INPUTFORMAT 'org.apache.hadoop.mapred.SequenceFileInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.mapred.SequenceFileOutputFormat'
```

### 2.5 PARQUET

é¢å‘åˆ—çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œæ‰€ä»¥æ˜¯ä¸å¯ä»¥ç›´æ¥è¯»å–çš„ï¼›

æ–‡ä»¶ä¸­åŒ…æ‹¬è¯¥æ–‡ä»¶çš„æ•°æ®å’Œå…ƒæ•°æ®ï¼Œå› æ­¤ `Parquet` æ ¼å¼æ–‡ä»¶æ˜¯è‡ªè§£æçš„ï¼›

ä½¿ç”¨åœºæ™¯åœ¨ `Impala` å’Œ `Hive` å…±äº«æ•°æ®å’Œå…ƒæ•°æ®çš„åœºæ™¯ï¼›

```sql
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
STORED AS PARQUET
-- ä¹Ÿå¯ä»¥ä½¿ç”¨
-- STORED AS PARQUETFILE
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
;
1234567891011
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe'
STORED AS 
INPUTFORMAT 'org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat'
```

### 2.6 ORCFILE

è¿ç”¨ `ORC` å¯ä»¥æé«˜ `HIVE` çš„è¯»ã€å†™ã€è®¡ç®—çš„æ€§èƒ½ï¼Œä¸»è¦ä½¿ç”¨åœ¨ `DWDã€DWBã€DWS` å±‚

- æ•°æ®æŒ‰è¡Œåˆ†å—ï¼Œæ¯å—æŒ‰ç…§åˆ—å­˜å‚¨ï¼›

- å‹ç¼©å¿«ã€å¿«é€Ÿåˆ—å­˜å–ï¼›

æ•ˆç‡æ¯” `rcfile` é«˜ï¼Œæ˜¯ `rcfile` çš„æ”¹è‰¯ç‰ˆæœ¬ï¼›

ä¸è€ƒè™‘ `ORC` çš„åœºæ™¯ï¼šéœ€è¦é€šè¿‡ `LOAD` æ–¹å¼åŠ è½½æ•°æ®åˆ°è¡¨é‡Œï¼›éœ€è¦æŠŠè¡¨é‡Œæ•°æ®å¯¼å‡ºæˆ–ç›´æ¥å¯ä»¥æŸ¥çœ‹ç­‰åœºæ™¯ï¼Œè¿™ä¸¤ç§åœºæ™¯æ›´é€‚åˆä½¿ç”¨ `TEXTFILE` ï¼Œæ˜“è¯»æ€§è¦æ¯” `ORC` é«˜å¾ˆå¤šï¼›

ORC æ–‡ä»¶æ ¼å¼å¯ä»¥ä½¿ç”¨ HIVE è‡ªå¸¦çš„å‘½ä»¤ `concatenate` å¿«é€Ÿåˆå¹¶å°æ–‡ä»¶

```sql
CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
-- ä¹Ÿå¯ä»¥ä½¿ç”¨ STORED AS ORCFILE
-- æŒ‡å®šå‹ç¼©ç®—æ³•
STORED AS ORC TBLPROPERTIES ("orc.compress"="SNAPPY");
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
;


CREATE TABLE CUST_INFO
(
   user_id    string   COMMENT 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  ,user_name  string   COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯æ˜ç»†è¡¨'
ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.orc.OrcSerde'
STORED AS 
INPUTFORMAT 'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'
PARTITIONED BY(ds string COMMENT 'æŒ‰äº¤æ˜“æ—¥åˆ†åŒº')
;
```

### 2.7 ä½¿ç”¨æ€»ç»“

```bash
# å‹ç¼©æ¯”æ¯”è¾ƒ
ORC>  PARQUET > TEXTFILE
# æŸ¥è¯¢é€Ÿåº¦
ORC >  TEXTFILE > PARQUET
# å­˜å‚¨æ ¼å¼ä¸ºORC,ä¸åŒçš„å‹ç¼©ç®—æ³•æ¯”è¾ƒå‹ç¼©åçš„æ–‡ä»¶å¤§å°
ZLIB < SNAPPY < éå‹ç¼©
```

â‘  æ•°æ®é‡è¾ƒå¤§

å¦‚æœå•ä¸ªæ–‡ä»¶æ¯”è¾ƒå¤§ï¼Œå¯ä»¥ä½¿ç”¨ `Parquet` å­˜å‚¨ï¼Œ`lzo` å‹ç¼©ï¼Œå¯ä»¥é¿å…ç”±äºè¯»å–ä¸å¯åˆ†å‰²å¤§æ–‡ä»¶å¼•å‘çš„æ•°æ®å€¾æ–œ

â‘¡ è®¡ç®—é€»è¾‘æ¯”è¾ƒå°‘

ä½¿ç”¨ `ORC` å­˜å‚¨ + `ZLIB` å‹ç¼©ï¼Œå¯ä»¥å°½é‡å‡å°‘å ç”¨å­˜å‚¨ç©ºé—´

â‘¢ è®¡ç®—é€»è¾‘æ¯”è¾ƒå¤š

ä½¿ç”¨ `ORC` å­˜å‚¨ + `SNAPPY` å‹ç¼©ï¼Œå¯ä»¥æé«˜è¯»å†™é€Ÿåº¦ï¼Œä»è€Œæé«˜æ•´ä½“è®¡ç®—æ€§èƒ½

## 3 Hiveåˆ†åŒºè¡¨

- [å¤§æ•°æ®ä¹‹hiveï¼ˆæ•°æ®ä»“åº“å·¥å…·ï¼‰çš„åˆ†ç»„å’Œåˆ†åŒºæ“ä½œ](https://blog.csdn.net/a18379692263/article/details/123170951)
- [Hiveåˆ†åŒº](https://blog.csdn.net/hyj_king/article/details/104966045)
- [Hiveåˆ†åŒºè¡¨è¯¦ç»†ä»‹ç»](https://juejin.cn/post/7040689938521653285#heading-13)

åˆ†åŒºè¡¨å®é™…ä¸Šå°±æ˜¯å¯¹åº”ä¸€ä¸ª HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹æ˜¯è¯¥åˆ†åŒºæ‰€æœ‰çš„æ•°æ®æ–‡ä»¶ã€‚Hive ä¸­çš„åˆ†åŒºå°±æ˜¯åˆ†ç›®å½•ï¼ŒæŠŠä¸€ä¸ªå¤§çš„æ•°æ®é›†æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ†å‰²æˆå°çš„æ•°æ®é›†ã€‚åœ¨æŸ¥è¯¢æ—¶é€šè¿‡ WHERE å­å¥ä¸­çš„è¡¨è¾¾å¼é€‰æ‹©æŸ¥è¯¢æ‰€éœ€è¦çš„æŒ‡å®šçš„åˆ†åŒºï¼Œè¿™æ ·çš„æŸ¥è¯¢æ•ˆç‡ä¼šæé«˜å¾ˆå¤šã€‚

### 3.1 Hiveåˆ†åŒºæ¦‚è¿°

#### 3.1.1 Hiveåˆ†åŒºèƒŒæ™¯

åœ¨Hive SelectæŸ¥è¯¢ä¸­ä¸€èˆ¬ä¼šæ‰«ææ•´ä¸ªè¡¨å†…å®¹ï¼Œä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´åšæ²¡å¿…è¦çš„å·¥ä½œã€‚æœ‰æ—¶å€™åªéœ€è¦æ‰«æè¡¨ä¸­å…³å¿ƒçš„ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå› æ­¤å»ºè¡¨æ—¶å¼•å…¥äº†partitionæ¦‚å¿µã€‚

#### 3.1.2 Hiveåˆ†åŒºå®è´¨

å› ä¸ºHiveå®é™…æ˜¯å­˜å‚¨åœ¨HDFSä¸Šçš„æŠ½è±¡ï¼ŒHiveçš„ä¸€ä¸ªåˆ†åŒºåå¯¹åº”hdfsçš„ä¸€ä¸ªç›®å½•åï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®é™…å­—æ®µã€‚

#### 3.1.3 Hiveåˆ†åŒºçš„æ„ä¹‰

è¾…åŠ©æŸ¥è¯¢ï¼Œç¼©å°æŸ¥è¯¢èŒƒå›´ï¼ŒåŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦å’Œå¯¹æ•°æ®æŒ‰ç…§ä¸€å®šçš„è§„æ ¼å’Œæ¡ä»¶è¿›è¡Œç®¡ç†ã€‚

#### 3.1.4 å¸¸è§çš„åˆ†åŒºæŠ€æœ¯

hiveè¡¨ä¸­çš„æ•°æ®ä¸€èˆ¬æŒ‰ç…§æ—¶é—´ã€åœ°åŸŸã€ç±»åˆ«ç­‰ç»´åº¦è¿›è¡Œåˆ†åŒºã€‚

### 3.2 åˆ†åŒºæ“ä½œ

#### 3.2.1 é™æ€åˆ†åŒº

##### 3.2.1.1 å•åˆ†åŒº

**(1)åˆ›å»ºè¡¨**

```sql
hive> create table student(id string,name string) partitioned by(classRoom string) row format delimited fields terminated by ',';
OK
Time taken: 0.259 seconds
```

æ³¨æ„ï¼špartitioned by()è¦æ”¾åœ¨row format...çš„å‰é¢ï¼›partitioned by()é‡Œé¢çš„åˆ†åŒºå­—æ®µä¸èƒ½å’Œè¡¨ä¸­çš„å­—æ®µé‡å¤ï¼Œå¦åˆ™æŠ¥é”™ï¼›

**(2)åŠ è½½æ•°æ®**

```sql
hive> load data local inpath '/home/test/stu.txt' into table student partition(classroom='002');
Loading data to table default.student partition (classroom=002)
OK
```

**(3)æŸ¥çœ‹åˆ†åŒº**

```sql
hive> show partitions student;
OK
classroom=002
Time taken: 0.071 seconds, Fetched: 1 row(s)
```

##### 3.2.1.2 å¤šåˆ†åŒº

**(1)åˆ›å»ºè¡¨**

```sql
hive> create table stu(id string,name string) partitioned by(school string,classRoom string) row format delimited fields terminated by ',';
OK
Time taken: 0.074 seconds
hive> desc stu;
OK
id                  	string              	                    
name                	string              	                    
school              	string              	                    
classroom           	string              	                    
	 	 
# Partition Information	 	 
# col_name            	data_type           	comment             
	 	 
school              	string              	                    
classroom           	string              	                    
Time taken: 0.03 seconds, Fetched: 10 row(s)
```

**(2)åŠ è½½æ•°æ®**

```sql
hive> load  data local inpath '/home/test/stu.txt' into table stu partition(school='AA',classroom='005');
Loading data to table default.stu partition (school=AA, classroom=005)
OK
Time taken: 0.779 seconds
hive> select * from stu;
OK
001	xiaohong	AA	005
002	xiaolan	AA	005
Time taken: 0.087 seconds, Fetched: 2 row(s)
```

**(3)æŸ¥çœ‹åˆ†åŒº**

```sql
hive> show partitions stu;
OK
school=AA/classroom=005
Time taken: 0.048 seconds, Fetched: 1 row(s)
```

æ³¨æ„ï¼šè¿™æ˜¯ä¸ªåµŒå¥—ç›®å½•ï¼›

#### 3.2.2 åŠ¨æ€åˆ†åŒº

é™æ€åˆ†åŒºä¸åŠ¨æ€åˆ†åŒºçš„ä¸»è¦åŒºåˆ«åœ¨äºé™æ€åˆ†åŒºæ˜¯æ‰‹åŠ¨æŒ‡å®šï¼Œè€ŒåŠ¨æ€åˆ†åŒºæ˜¯é€šè¿‡æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­ã€‚è¯¦ç»†æ¥è¯´ï¼Œé™æ€åˆ†åŒºçš„åˆ—å®åœ¨ç¼–è¯‘æ—¶æœŸï¼Œé€šè¿‡ç”¨æˆ·ä¼ é€’æ¥å†³å®šçš„ï¼›åŠ¨æ€åˆ†åŒºåªæœ‰åœ¨SQLæ‰§è¡Œæ—¶æ‰èƒ½å†³å®šã€‚

##### 3.2.2.1 å¯ç”¨hiveåŠ¨æ€åˆ†åŒº

åœ¨hiveä¼šè¯ä¸­è®¾ç½®ä¸¤ä¸ªå‚æ•°ï¼š

```
hive> set hive.exec.dynamic.partition=true;
hive> set hive.exec.dynamic.partition.mode=nonstrict;
```

##### 3.2.2.2 åˆ›å»ºè¡¨

**(1)é¦–å…ˆå‡†å¤‡ä¸€ä¸ªå¸¦æœ‰é™æ€åˆ†åŒºçš„è¡¨**

```sql
hive> select * from stu;
OK
001	xiaohong	AA	001
002	xiaolan	AA	001
001	xiaohong	AA	005
002	xiaolan	AA	005
001	xiaohong	BB	001
002	xiaolan	BB	001
Time taken: 0.105 seconds, Fetched: 6 row(s)
```

**(2)copyä¸€å¼ è¡¨ç»“æ„ç›¸åŒçš„è¡¨**

```sql
hive> create table stu01 like stu;
OK
Time taken: 0.068 seconds
hive> desc stu;
OK
id                  	string              	                    
name                	string              	                    
school              	string              	                    
classroom           	string              	                    
	 	 
# Partition Information	 	 
# col_name            	data_type           	comment             
	 	 
school              	string              	                    
classroom           	string              	                    
Time taken: 0.022 seconds, Fetched: 10 row(s)
```

**(3)åŠ è½½æ•°æ®ï¼Œåˆ†åŒºæˆåŠŸ**

ä¸æŒ‡å®šå…·ä½“çš„å­¦æ ¡å’Œç­çº§ï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼›

```sql
hive> insert overwrite table stu01 partition(school,classroom) 
    > select * from stu;
hive> select * from stu;
OK
001	xiaohong	AA	001
002	xiaolan	AA	001
001	xiaohong	AA	005
002	xiaolan	AA	005
001	xiaohong	BB	001
002	xiaolan	BB	001
Time taken: 0.091 seconds, Fetched: 6 row(s)
hive> select * from stu01;
OK
001	xiaohong	AA	001
002	xiaolan	AA	001
001	xiaohong	AA	005
002	xiaolan	AA	005
001	xiaohong	BB	001
002	xiaolan	BB	001
Time taken: 0.081 seconds, Fetched: 6 row(s)
```

### 3.3 åˆ†åŒºè¡¨åŸºæœ¬æ“ä½œ

1ï¼‰åˆ›å»ºåˆ†åŒºè¡¨

```sql
create table dept_par(deptno int,dname string,loc string) partitioned by(day string)
row format delimited fields terminated by '\t';
```

 æ³¨ï¼šåˆ†åŒºè¡¨è®¾ç½®çš„åˆ†åŒºå­—æ®µè¦åŒºåˆ«äºè¡¨ä¸­å­—æ®µ

 2ï¼‰åŠ è½½æ•°æ®åˆ°åˆ†åŒºè¡¨ï¼ˆæ•°æ®å‡†å¤‡ï¼Œåœ¨æœ¬åœ°åˆ›å»ºæ–‡ä»¶æ•°æ®ï¼‰

```bash
dept_20220225.txt
10 ACCOUNTING 1700
20 RESEARCH 1800

dept_20220226.txt
30 SALES 1900
40 OPERATIONS 1700

dept_20220227.txt
50 TEST 2000
60 DEV 1900
```

åŠ è½½æ•°æ®åˆ°å…·ä½“çš„åˆ†åŒº

```sql
load data inpath '/opt/module/hive/data/dept_20220225.txt' into table dept_par partition(day='20220225');
load data inpath '/opt/module/hive/data/dept_20220226.txt' into table dept_par partition(day='20220226');
load data inpath '/opt/module/hive/data/dept_20220227.txt' into table dept_par partition(day='20220227');
```

 å³å¯åœ¨hdfsé›†ç¾¤ä¸ŠæŸ¥çœ‹åŠ è½½çš„åˆ†åŒºæ•°æ®

 3ï¼‰åˆ†åŒºè¡¨æ•°æ®æŸ¥è¯¢

```sql
å•åˆ†åŒºæ•°æ®æŸ¥è¯¢
 select * from dept_partition where day='20220225';
å¤šåˆ†åŒºæ•°æ®æŸ¥è¯¢
 select * from dept_partition where day='20220225'
 union
 select * from dept_partition where day='20220226'
 union
 select * from dept_partition where day='20220227';
```

4ï¼‰ å¢åŠ åˆ†åŒº

```sql
alter table dept_par add partition(day='20220228');
åˆ›å»ºå¤šä¸ªåˆ†åŒº
alter table dept_partition add partition(day='20220224') ,partition(day='20220223');
```

5ï¼‰åˆ é™¤åˆ†åŒº

```sql
alter table dept_partition drop partition (day='20220224');
åŒæ—¶åˆ é™¤å¤šä¸ªåˆ†åŒº
alter table dept_partition drop partition (day='20220223'), partition(day='20220228');
æ³¨ï¼šåˆ é™¤å’Œå¢åŠ åˆ†åŒºä»¥é€—å·åŒºåˆ†
```

6ï¼‰æŸ¥çœ‹åˆ†åŒºè¡¨ä¿¡æ¯

```sql
åˆ†åŒºè¡¨ç»“æ„
desc formatted dept_partition;
æŸ¥çœ‹å¤šå°‘ä¸ªåˆ†åŒº
show partitions dept_partition;
```

### 3.4 äºŒçº§åˆ†åŒº

å¦‚æœä¸€å¤©çš„æ•°æ®é‡ä¹Ÿå¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå°±è¦åœ¨æ¯å¤©ä¸‹é¢åœ¨å¯¹æ¯ä¸ªå°æ—¶çš„æ•°æ®è¿›è¡Œåˆ†åŒº

1ï¼‰åˆ›å»ºäºŒçº§åˆ†åŒº

```sql
create table dept_partition2(
 deptno int, dname string, loc string
 )
 partitioned by (day string, hour string)
 row format delimited fields terminated by '\t';
```

2ï¼‰åŠ è½½æ•°æ®

```sql
load data local inpath 
'/opt/module/hive/datas/dept_20220225.txt' into table
dept_partition2 partition(day='20220225', hour='12');
```

3ï¼‰æŸ¥çœ‹åˆ†åŒºæ•°æ®

```sql
select * from dept_partition2 where day='20220225' and hour='12';
```

### 3.5 åŠ¨æ€åˆ†åŒºè°ƒæ•´ï¼ˆå³åˆ†åŒºçš„æ•°æ®æŒ‰ç…§è¡¨å­—æ®µæ¥åˆ†åŒºï¼‰

å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¯¹åˆ†åŒºè¡¨ Insert æ•°æ®æ—¶å€™ï¼Œæ•°æ®åº“è‡ªåŠ¨ä¼šæ ¹æ®åˆ†åŒºå­—æ®µçš„å€¼ï¼Œå°†æ•°æ® æ’å…¥åˆ°ç›¸åº”çš„åˆ†åŒºä¸­ï¼ŒHive ä¸­ä¹Ÿæä¾›äº†ç±»ä¼¼çš„æœºåˆ¶ï¼Œå³åŠ¨æ€åˆ†åŒº(Dynamic Partition)ï¼Œåªä¸è¿‡ï¼Œ ä½¿ç”¨ Hive çš„åŠ¨æ€åˆ†åŒºï¼Œéœ€è¦è¿›è¡Œç›¸åº”çš„é…ç½®ã€‚

1ï¼‰è®¾ç½®ä¸ºéä¸¥æ ¼æ¨¡å¼ï¼ˆåŠ¨æ€åˆ†åŒºçš„æ¨¡å¼ï¼Œé»˜è®¤ strictï¼Œè¡¨ç¤ºå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªåˆ†åŒºä¸º é™æ€åˆ†åŒºï¼Œnonstrict æ¨¡å¼è¡¨ç¤ºå…è®¸æ‰€æœ‰çš„åˆ†åŒºå­—æ®µéƒ½å¯ä»¥ä½¿ç”¨åŠ¨æ€åˆ†åŒºã€‚ï¼‰

```delphi
set hive.exec.dynamic.partition.mode=nonstrict
```

 ä¾‹å¦‚ï¼šï¼šå°† dept è¡¨ä¸­çš„æ•°æ®æŒ‰ç…§åœ°åŒºï¼ˆloc å­—æ®µï¼‰ï¼Œæ’å…¥åˆ°ç›®æ ‡è¡¨ dept_partition çš„ç›¸åº”åˆ†åŒºä¸­ã€‚

åˆ›å»ºç›®æ ‡åˆ†åŒºè¡¨

```sql
create table dept_par4(id int, name string) 
partitioned by (loc int) row format delimited fields terminated by '\t';
```

 è®¾ç½®åŠ¨æ€åˆ†åŒº

```sql
insert into table dept_par4 partition(loc) select deptno, dname, loc from dept;
```

æ³¨ï¼šæŸ¥è¯¢è¯­å¥çš„æœ€åå­—æ®µé»˜è®¤ä¸ºåˆ†åŒºå­—æ®µã€‚

## 4 åˆ†æ¡¶è¡¨

åˆ†åŒºæä¾›ä¸€ä¸ªéš”ç¦»æ•°æ®å’Œä¼˜åŒ–æŸ¥è¯¢çš„ä¾¿åˆ©æ–¹å¼ã€‚ä¸è¿‡ï¼Œå¹¶éæ‰€æœ‰çš„æ•°æ®é›†éƒ½å¯å½¢æˆåˆç†çš„åˆ†åŒºã€‚å¯¹äºä¸€å¼ è¡¨æˆ–è€…åˆ†åŒºï¼ŒHive å¯ä»¥è¿›ä¸€æ­¥ç»„ç»‡æˆæ¡¶ï¼Œä¹Ÿå°±æ˜¯æ›´ä¸ºç»†ç²’åº¦çš„æ•°æ®èŒƒå›´åˆ’åˆ†ã€‚

åˆ†æ¡¶æ˜¯å°†æ•°æ®é›†åˆ†è§£æˆæ›´å®¹æ˜“ç®¡ç†çš„è‹¥å¹²éƒ¨åˆ†çš„å¦ä¸€ä¸ªæŠ€æœ¯ã€‚

åˆ†åŒºé’ˆå¯¹çš„æ˜¯æ•°æ®çš„å­˜å‚¨è·¯å¾„ï¼›åˆ†æ¡¶é’ˆå¯¹çš„æ˜¯æ•°æ®æ–‡ä»¶ã€‚

1ï¼‰åˆ›å»ºåˆ†æ¡¶è¡¨

```sql
create table stu_buck(id int, name string)
clustered by(id) 
into 4 buckets
row format delimited fields terminated by '\t';
```

2ï¼‰å¯¼å…¥æ•°æ®ï¼ˆhdfsä¸Šçš„æ•°æ®ï¼‰

```sql
load data inpath '/student.txt' into table stu_buck;
```

æ³¨ï¼šHive çš„åˆ†æ¡¶é‡‡ç”¨å¯¹åˆ†æ¡¶å­—æ®µçš„å€¼è¿›è¡Œå“ˆå¸Œï¼Œç„¶åé™¤ä»¥æ¡¶çš„ä¸ªæ•°æ±‚ä½™çš„æ–¹ å¼å†³å®šè¯¥æ¡è®°å½•å­˜æ”¾åœ¨å“ªä¸ªæ¡¶å½“ä¸­ã€‚

### 4.1 æŠ½æ ·æŸ¥è¯¢

å¯¹äºéå¸¸å¤§çš„æ•°æ®é›†ï¼Œæœ‰æ—¶ç”¨æˆ·éœ€è¦ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„æŸ¥è¯¢ç»“æœè€Œä¸æ˜¯å…¨éƒ¨ç»“æœã€‚Hive å¯ä»¥é€šè¿‡å¯¹è¡¨è¿›è¡ŒæŠ½æ ·æ¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚

è¯­æ³•: TABLESAMPLE(BUCKET x OUT OF y)ï¼ˆæ³¨æ„ï¼šx çš„å€¼å¿…é¡»å°äºç­‰äº y çš„å€¼ï¼‰

æŸ¥è¯¢è¡¨ stu_buck ä¸­çš„æ•°æ®ï¼ˆä»ç¬¬ä¸€ä¸ªæ¡¶å¼€å§‹åˆ°ç¬¬å››ä¸ªæ¡¶ï¼ˆ4è¡¨ç¤ºå°†å…¨éƒ¨æ•°æ®éšæœºåˆ†ä¸ºå››ä»½ï¼‰ï¼ŒéšæœºæŠ½å–ä¸€ä¸ªæ¡¶çš„æ•°æ®ï¼‰ã€‚

```csharp
select * from stu_buck tablesample(bucket 1 out of 4 on id);
```

# 5 Hiveå†…éƒ¨è¡¨å¤–éƒ¨è¡¨

- [Hiveå†…éƒ¨è¡¨å¤–éƒ¨è¡¨åŒºåˆ«åŠå„è‡ªä½¿ç”¨åœºæ™¯ ã€ é™„å½•ï¼šå¸¸è§„DDLæ ·ä¾‹ã€‘](https://blog.csdn.net/liuge36/article/details/111425996)

## 5.1  åŒºåˆ«

ç®€å•æ¥è¯´ï¼š

1. åœ¨å»ºè¡¨çš„æ—¶å€™ï¼Œå¤–éƒ¨è¡¨è¦ä½¿ç”¨ EXTERNAL å…³é”®å­—ï¼Œä¸æŒ‡å®šé»˜è®¤æ˜¯å†…éƒ¨è¡¨;
2. åˆ›å»ºå¤–éƒ¨è¡¨çš„åŒæ—¶ï¼Œè¯­å¥æœ«å°¾ä¸€èˆ¬è¦è‡ªå·±æŒ‡å®š æ•°æ®æ–‡ä»¶å­˜å‚¨è·¯å¾„ location â€˜/AUTO/PATHâ€™
3. å†…éƒ¨è¡¨ä¸ç”¨ç‰¹æ®ŠæŒ‡å®šï¼Œé»˜è®¤ä¸º/user/hive/warehouseï¼Œå¯é…ç½®ï¼šhive-site.xmlï¼š

```xml
<property>
    <name>hive.metastore.warehouse.dir</name>
    <value>/hive/warehouse</value>
</property>
```

1. å†…éƒ¨è¡¨æ•°æ®ç”±Hiveè‡ªèº«ç®¡ç†ï¼Œå¤–éƒ¨è¡¨æ•°æ®ç”±HDFSç®¡ç†ï¼›
2. DTOP TABLEï¼Œ
   å†…éƒ¨è¡¨ï¼šå…ƒæ•°æ®å’Œæ•°æ®æ–‡ä»¶éƒ½ä¼šè¢«åˆ é™¤æ‰
   å¤–éƒ¨è¡¨ï¼šå…ƒæ•°æ®è¢«åˆ é™¤ï¼Œæ•°æ®æ–‡ä»¶ä»»ç„¶ä¿ç•™ ,æ­¤æ—¶é‡å»ºè¡¨éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿˜æ˜¯å¯ä»¥ç›´æ¥æŸ¥æ•°æ®çš„
3. LOAD DATA ,
   åŠ è½½HDFS DATA éƒ½æ˜¯ä¼šå°†HDFSæ•°æ®è¿›è¡Œç§»åŠ¨åˆ°å¯¹åº”çš„è¡¨ç›®å½•ï¼Œç±»ä¼¼ mv å‘½ä»¤

## 5.2 ä½¿ç”¨åœºæ™¯

ç®€å•æ¥è¯´ï¼š

1. æ¯å¤©é‡‡é›†çš„ngæ—¥å¿—å’ŒåŸ‹ç‚¹æ—¥å¿—,åœ¨å­˜å‚¨çš„æ—¶å€™å»ºè®®ä½¿ç”¨å¤–éƒ¨è¡¨ï¼Œå› ä¸ºæ—¥å¿—æ•°æ®æ˜¯é‡‡é›†ç¨‹åºå®æ—¶é‡‡é›†è¿›æ¥çš„ï¼Œä¸€æ—¦è¢«è¯¯åˆ ï¼Œæ¢å¤èµ·æ¥éå¸¸éº»çƒ¦ã€‚è€Œä¸”å¤–éƒ¨è¡¨æ–¹ä¾¿æ•°æ®çš„å…±äº«ã€‚
2. æŠ½å–è¿‡æ¥çš„ä¸šåŠ¡æ•°æ®ï¼Œå…¶å®ç”¨å¤–éƒ¨è¡¨æˆ–è€…å†…éƒ¨è¡¨é—®é¢˜éƒ½ä¸å¤§ï¼Œå°±ç®—è¢«è¯¯åˆ ï¼Œæ¢å¤èµ·æ¥ä¹Ÿæ˜¯å¾ˆå¿«çš„ï¼Œå¦‚æœéœ€è¦å¯¹æ•°æ®å†…å®¹å’Œå…ƒæ•°æ®è¿›è¡Œç´§å‡‘çš„ç®¡ç†, é‚£è¿˜æ˜¯å»ºè®®ä½¿ç”¨å†…éƒ¨è¡¨
3. åœ¨åšç»Ÿè®¡åˆ†ææ—¶å€™ç”¨åˆ°çš„ä¸­é—´è¡¨ï¼Œç»“æœè¡¨å¯ä»¥ä½¿ç”¨å†…éƒ¨è¡¨ï¼Œå› ä¸ºè¿™äº›æ•°æ®ä¸éœ€è¦å…±äº«ï¼Œä½¿ç”¨å†…éƒ¨è¡¨æ›´ä¸ºåˆé€‚ã€‚å¹¶ä¸”å¾ˆå¤šæ—¶å€™ç»“æœåˆ†åŒºè¡¨æˆ‘ä»¬åªéœ€è¦ä¿ç•™æœ€è¿‘3å¤©çš„æ•°æ®ï¼Œç”¨å¤–éƒ¨è¡¨çš„æ—¶å€™åˆ é™¤åˆ†åŒºæ—¶æ— æ³•åˆ é™¤æ•°æ®ã€‚

é™„ä¸€æ®µå†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨å¸¸è§„DDLè¯­å¥

å†…éƒ¨è¡¨ï¼š

- å†…éƒ¨è¡¨æ•°æ®å­˜å‚¨çš„ä½ç½®æ˜¯hiveåœ¨hdfsä¸­å­˜åœ¨é»˜è®¤çš„å­˜å‚¨è·¯å¾„ï¼Œå³defaultæ•°æ®åº“ï¼ˆé»˜è®¤ï¼š/user/hive/warehouseï¼‰
- å†…éƒ¨è¡¨çš„æ•°æ®æ˜¯Hiveè‡ªèº«ç®¡ç†ï¼Œåˆ›å»ºå†…éƒ¨è¡¨æ—¶ï¼Œä¼šå°†æ•°æ®ç§»åŠ¨åˆ°æ•°æ®ä»“åº“æŒ‡å‘çš„è·¯å¾„
- åˆ é™¤å†…éƒ¨è¡¨ä¼šç›´æ¥åˆ é™¤å…ƒæ•°æ®ï¼ˆmetadataï¼‰åŠå­˜å‚¨æ•°æ®ï¼Œå¯¹å†…éƒ¨è¡¨çš„ä¿®æ”¹ä¼šå°†ä¿®æ”¹ç›´æ¥åŒæ­¥ç»™å…ƒæ•°æ®

```sql
# demo1
create  table test(
user_id string,
user_name string,
hobby array<string>,
scores map<string,int>
)
row format delimited
fields terminated by '|'
collection items terminated by ','
map keys terminated by ':'
lines terminated by '\n';

# demo2
create table students
(
    id bigint,
    name string,
    age int,
    school string,
    class string
)
#æŒ‡å®šåˆ†éš”ç¬¦ï¼ˆä¸‹é¢è¯­å¥è¡¨ç¤ºæ•°æ®ä»¥é€—å·åˆ†éš”å¼€ï¼‰
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','   
#æ‰‹åŠ¨æŒ‡å®šè¯¥å†…éƒ¨è¡¨è¡¨æ ¼åˆ›å»ºåœ¨HDFSä¸‹çš„/user/hive/warehouseç›®å½•å†…ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤å­˜æ”¾/user/hive/warehouseä¸‹
LOCATION '/user/hive/warehouse';
```

å¤–éƒ¨è¡¨ï¼š

- å¤–éƒ¨è¡¨æ•°æ®å­˜å‚¨çš„ä½ç½®å¯ä»¥è‡ªå·±æŒ‡å®šï¼ŒæŒ‡å®šé™¤/user/hive/warehouseä»¥å¤–çš„è·¯å¾„ã€‚
- å¤–éƒ¨è¡¨æ•°æ®ç”±HDFSç®¡ç†ï¼Œåˆ›å»ºå¤–éƒ¨è¡¨æ—¶ï¼Œä»…è®°å½•æ•°æ®æ‰€åœ¨çš„è·¯å¾„ï¼Œä¸å¯¹æ•°æ®çš„ä½ç½®åšä»»ä½•æ”¹å˜ã€‚
- åˆ é™¤å¤–éƒ¨è¡¨ä»…ä»…ä¼šåˆ é™¤å…ƒæ•°æ®ï¼ŒHDFSä¸Šçš„æ–‡ä»¶å¹¶ä¸ä¼šè¢«åˆ é™¤ï¼Œè€Œå¯¹å¤–éƒ¨è¡¨çš„è¡¨ç»“æ„å’Œåˆ†åŒºè¿›è¡Œä¿®æ”¹ï¼Œåˆ™éœ€è¦ä¿®å¤ï¼ˆMSCK REPAIR TABLE table_nameï¼‰

```sql
# demo1
create external table external_test(
user_id string,
user_name string,
hobby array<string>,
scores map<string,int>
)
row format delimited
fields terminated by '|'
collection items terminated by ','
map keys terminated by ':'
lines terminated by '\n'
location '/warehouse/db01.db';

# demo2
# å…³é”®è¯external è¡¨ç¤ºåˆ›å»ºçš„hiveè¡¨ä¸ºå¤–éƒ¨è¡¨
create external table students
(
    id bigint,
    name string,
    age int,
    school string,
    class string
)
#æŒ‡å®šåˆ†éš”ç¬¦ï¼ˆä¸‹é¢è¯­å¥è¡¨ç¤ºæ•°æ®ä»¥é€—å·åˆ†éš”å¼€ï¼‰
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','   
#æ‰‹åŠ¨æŒ‡å®šè¯¥å†…éƒ¨è¡¨è¡¨æ ¼åˆ›å»ºåœ¨HDFSä¸‹çš„/user/hive/warehouse_external ç›®å½•å†…
LOCATION '/user/hive/warehouse_external ';
```

åˆ†åŒºè¡¨ï¼š

```sql
create  table partition_test(
user_id string,
user_name string,
hobby array<string>,
scores map<string,int>
)
partitioned by (time string)
row format delimited
fields terminated by '|'
collection items terminated by ','
map keys terminated by ':'
lines terminated by '\n';
```

åˆ†æ¡¶è¡¨ï¼š

```sql
create  table bucket_test(
user_id string,
user_name string,
hobby array<string>,
scores map<string,int>
)
clustered by (user_name) sorted by (user_name) into 3 buckets
row format delimited
fields terminated by '|'
collection items terminated by ','
map keys terminated by ':'
lines terminated by '\n';
```

ğŸš€ğŸš€è£…è½½æ•°æ®

```sql
LOAD DATA [LOCAL] INPATH 'filepath' [OVERWRITE] INTO TABLE tablename [PARTITION (partcol1=val1, partcol2=val2 ...)]
```

## 5.3 å†…éƒ¨è¡¨è½¬æ¢ä¸ºå¤–éƒ¨è¡¨

```sql
alter table table_name set tblproperties('EXTERNAL'='TRUE');
å¯ä»¥é€šè¿‡ desc formatted è¡¨å  æ¥æŸ¥çœ‹è¡¨çš„å±æ€§
```
