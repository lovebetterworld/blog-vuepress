---
title: 04.TDengine SQL
date: 2022-09-13 16:36:34
permalink: /TDengine/TDengine04/
categories: 
  - TDengine
tags: 
  - TDengine
---

## 1 支持的数据类型

使用TDengine，最重要的是时间戳。创建并插入记录、查询历史记录的时候，均需要指定时间戳。时间戳有如下规则：

- 时间格式为`YYYY-MM-DD HH:mm:ss.MS`, 默认时间分辨率为毫秒。比如：`2017-08-12 18:25:58.128`
- 内部函数now是服务器的当前时间
- 插入记录时，如果时间戳为0，插入数据时使用服务器当前时间
- Epoch Time: 时间戳也可以是一个长整数，表示从1970-01-01 08:00:00.000开始的毫秒数
- 时间可以加减，比如 now-2h，表明查询时刻向前推2个小时(最近2小时)。数字后面的时间单位：a(毫秒), s(秒), m(分), h(小时), d(天)，w(周), n(月), y(年)。比如select * from t1 where ts > now-2w and ts <= now-1w, 表示查询两周前整整一周的数据
- TDengine暂不支持时间窗口按照自然年和自然月切分。Where条件中的时间窗口单位的换算关系如下：interval(1y) 等效于 interval(365d), interval(1n) 等效于 interval(30d), interval(1w) 等效于 interval(7d)

TDengine缺省的时间戳是毫秒精度，但通过修改配置参数enableMicrosecond就可支持微秒。

在TDengine中，普通表的数据模型中可使用以下10种数据类型。

|      | 类型      | Bytes  | 说明                                                         |
| :--- | :-------- | :----- | :----------------------------------------------------------- |
| 1    | TIMESTAMP | 8      | 时间戳。最小精度毫秒。从格林威治时间 1970-01-01 00:00:00.000 (UTC/GMT) 开始，计时不能早于该时间。 |
| 2    | INT       | 4      | 整型，范围 [-2^31+1, 2^31-1], -2^31用作Null                  |
| 3    | BIGINT    | 8      | 长整型，范围 [-2^63+1, 2^63-1], -2^63用于NULL                |
| 4    | FLOAT     | 4      | 浮点型，有效位数6-7，范围 [-3.4E38, 3.4E38]                  |
| 5    | DOUBLE    | 8      | 双精度浮点型，有效位数15-16，范围 [-1.7E308, 1.7E308]        |
| 6    | BINARY    | 自定义 | 用于记录字符串，理论上，最长可以有65526字节，但由于每行数据最多64K字节，实际上限一般小于理论值。 binary仅支持字符串输入，字符串两端使用单引号引用，否则英文全部自动转化为小写。使用时须指定大小，如binary(20)定义了最长为20个字符的字符串，每个字符占1byte的存储空间。如果用户字符串超出20字节将会报错。对于字符串内的单引号，可以用转义字符反斜线加单引号来表示， 即 **\’**。 |
| 7    | SMALLINT  | 2      | 短整型， 范围 [-32767, 32767], -32768用于NULL                |
| 8    | TINYINT   | 1      | 单字节整型，范围 [-127, 127], -128用于NULL                   |
| 9    | BOOL      | 1      | 布尔型，{true, false}                                        |
| 10   | NCHAR     | 自定义 | 用于记录非ASCII字符串，如中文字符。每个nchar字符占用4bytes的存储空间。字符串两端使用单引号引用，字符串内的单引号需用转义字符 **\’**。nchar使用时须指定字符串大小，类型为nchar(10)的列表示此列的字符串最多存储10个nchar字符，会固定占用40bytes的空间。如用户字符串长度超出声明长度，则将会报错。 |

**Tips**: TDengine对SQL语句中的英文字符不区分大小写，自动转化为小写执行。因此用户大小写敏感的字符串及密码，需要使用单引号将字符串引起来。

# 2 数据库管理

## 2.1 创建数据库

```
CREATE DATABASE [IF NOT EXISTS] db_name [KEEP keep]
```

创建数据库。`KEEP`是该数据库的数据保留多长天数，缺省是3650天(10年)，数据库会自动删除超过时限的数据。数据库还有更多与存储相关的配置参数，请参见系统管理。

示例：

```sql
CREATE DATABASE my_db KEEP 30 day 10 BLOCKS 6 PRECISION 'ns' UPDATE 2
```

1. KEEP 表示当前数据库数据需要保留的天数，超过天数的数据将被删除
2. DAY 表示每10天生成一个数据文件
3. BLOCKS表示内存块数为6, [解释](https://www.taosdata.com/docs/cn/v2.0/architecture#sharding)
4. PRECISION代表EpochTime表示的时间精度（从1970年开始到现在的纳秒数），支持纳秒(ns), 微秒(us),毫秒(ms), 默认值为毫秒, 指定其他精度时, 插入数据时需要特别注意精度
5. UPDATE设为0时，表示不允许更新数据，后发送的相同时间戳的数据会被直接丢弃；
6. UPDATE设为1时，表示更新全部列数据，即如果更新一个数据行，其中某些列没有提供取值，那么这些列会被设为 NULL；
7. UPDATE设为2时，表示支持更新部分列数据，即如果更新一个数据行，其中某些列没有提供取值，那么这些列会保持原有数据行中的对应值；

## 2.2 使用数据库

```
USE db_name
```

使用/切换数据库

## 2.3 删除数据库

```
DROP DATABASE [IF EXISTS] db_name
```

删除数据库。所包含的全部数据表将被删除，谨慎使用

## 2.4 显示系统所有数据库

```
 SHOW DATABASES
```

# 3 表管理

## 3.1 创建数据表

```bash
CREATE TABLE [IF NOT EXISTS] tb_name (timestamp_field_name TIMESTAMP, field1_name data_type1 [, field2_name data_type2 ...])
```

说明：

1）表的第一个字段必须是TIMESTAMP，并且系统自动将其设为主键；

2）表的每行长度不能超过4096字节；

3）使用数据类型binary或nchar，需指定其最长的字节数，如binary(20)，表示20字节。

## 3.2 删除数据表

```
DROP TABLE [IF EXISTS] tb_name
```

## 3.3 显示当前数据库下的所有数据表信息

```
SHOW TABLES [LIKE tb_name_wildcar]
```

显示当前数据库下的所有数据表信息。

说明：可在like中使用通配符进行名称的匹配。 通配符匹配：

1）’%’ (百分号)匹配0到任意个字符；

2）’_’下划线匹配一个字符。

## 3.4 获取表的结构信息

```
DESCRIBE tb_name
```

## 3.5 表增加列

```
ALTER TABLE tb_name ADD COLUMN field_name data_type
```

## 3.6 表删除列

```
ALTER TABLE tb_name DROP COLUMN field_name
```

如果表是通过超级表创建，更改表结构的操作只能对超级表进行。同时针对超级表的结构更改对所有通过该结构创建的表生效。对于不是通过超级表创建的表，可以直接修改表结构

**Tips**：SQL语句中操作的当前数据库（通过use db_name的方式指定）中的表不需要指定表所属数据库。如果要操作非当前数据库中的表，需要采用“库名”.“表名”的方式。例如：demo.tb1，是指数据库demo中的表tb1。