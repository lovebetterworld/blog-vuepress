---
title: 01.lskypro
date: 2022-04-06 09:54:57
permalink: /lskypro/c004c2/
categories:
  - LskyPro
tags:
  - 
---

> 参考系列博文：
>
> - [佛西博客 - Docker搭建lskypro兰空图床 (buduanwang.vip)](https://foxi.buduanwang.vip/linux/docker/323.html/)
> - [LskyPro2安装教程 - 咕咕乔's Blog (goojoe.cc)](https://goojoe.cc/115.html)
> - [开源的兰空图床LskyPro_杨浦老苏的博客-CSDN博客_兰空图床](https://blog.csdn.net/wbsu2004/article/details/118555096)
> - [【教程贴】Docker部署教程和相关问题讨论 · Discussion #373 · lsky-org/lsky-pro (github.com)](https://github.com/lsky-org/lsky-pro/discussions/373)
> - [hellodk34/picgo-plugin-lankong: A PicGo uploader for 兰空图床 lsky-pro，支持 V1 和 V2。 (github.com)](https://github.com/hellodk34/picgo-plugin-lankong)



## 1 Docker启动

```bash
docker run -d --name lsky -p 8090:80 -v /var/project/lsky:/var/www/html halcyonazure/lsky-pro-docker:latest
```

## 2 Nginx反向代理设置

如果使用Nginx反代并设置了HTTPS的话，会出现图片加载错误的情况，解决办法参考 [#317](https://github.com/lsky-org/lsky-pro/issues/317) 在32行添加对应代码后即可成功使用

在Docker内可直接执行以下指令来修改文件内容：

```bash
docker exec -it lskypro sed -i '32 a \\\Illuminate\\Support\\Facades\\URL::forceScheme('"'"'https'"'"');' /var/www/html/app/Providers/AppServiceProvider.php
```

## 3 记录Nginx配置

443端口是个人博客网站的，8443是配置LskyPro图床的。

```
user  root;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 10M;
    sendfile        on;
    keepalive_timeout  65;

    server {
       listen       80;
       server_name  XXXXXXXXXXX.com;
      rewrite ^(.*)$ https://$host$1 permanent;
    }
	
    server {
        listen 8443 ssl;
        server_name XXXXXXXXXXX.com;
        ssl_certificate XXXXXXXXXXX.pem; 
        ssl_certificate_key XXXXXXXXXXX.key; 
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 30m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!MD5:!EXPORT56:!EXP;
        ssl_prefer_server_ciphers on;
        proxy_connect_timeout 500;
        proxy_send_timeout 500;
        proxy_read_timeout 500;
        client_max_body_size 10m;

        location / {
            proxy_pass http://127.0.0.1:8090;
            # 此处后面加了端口号，因为此处，排查了两天问题
            proxy_set_header Host $host:8443;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header REMOTE-HOST $remote_addr;
        }
    }
	
	server {
        listen 443 ssl; 
        server_name XXXXXXXXXXX.com;
        ssl_certificate XXXXXXXXXXX.crt; 
        ssl_certificate_key XXXXXXXXXXX.key; 
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3; 
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
        ssl_prefer_server_ciphers on;
        location / {
            root html; 
            index  index.html index.htm;
        }
    }

}
```
