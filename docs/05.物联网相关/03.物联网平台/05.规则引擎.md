---
title: 05.规则引擎
date: 2022-04-14 09:10:42
permalink: /platform/rule8ced6/
categories:
  - 物联网
tags:
  - 
---

> 参考资料：
>
> - [从产品角度看物联网平台的规则引擎 | 人人都是产品经理 (woshipm.com)](http://www.woshipm.com/pd/4237660.html)



> 规则引擎是物联网平台的一个重要功能模块，是处理复杂逻辑的引擎，主要对感知层搜集的数据进行处理，实现数据逻辑和上层业务的解耦；

## 1 规则引擎是什么

### 1.1 为什么叫规则引擎

**规则引擎**，全称为**业务规则管理系统**，英文名为BRMS(即Business Rule Management System)。规则引擎的主要思想是将应用程序中的业务决策部分分离出来，并使用预定义的语义模块编写业务决策（业务规则），由用户或开发者在需要时进行配置、管理。

需要注意的是规则引擎并不是一个具体的技术框架，而是指的一类系统，即业务规则管理系统。目前市面上具体的规则引擎产品有：drools、VisualRules、iLog等。

规则引擎实现了将业务决策从应用程序代码中分离出来，接收数据输入，解释业务规则，并根据业务规则做出业务决策。规则引擎其实就是一个输入输出平台。

系统中引入规则引擎后，业务规则不再以程序代码的形式驻留在系统中，取而代之的是处理规则的规则引擎，业务规则存储在规则库中，完全独立于程序。业务人员可以像管理数据一样对业务规则进行管理，比如查询、添加、更新、统计、提交业务规则等。业务规则被加载到规则引擎中供应用系统调用。

### 1.2 为什么做规则引擎

物联网平台的基本功能就是对物的管理和对物产生的数据进行处理，数据的处理涉及数据的存储、流向、使用。

那么会自然的提出3个问题：

- 数据存储在哪里？
- 流转至什么地方？
- 怎么使用？

针对这3个问题都可以通过代码实现，但是不同的行业的业务规则复杂多样，通过代码实现的话代码量、逻辑分支、代码维护工作量会不可想象。

所以需要一种组件，可以将业务决策从代码中分离，易于编写、易于维护，基于这些需求，规则引擎应运而生。

其实这么解释总觉的有一点事后诸葛亮，一种组件的诞生肯定伴随的需求和功能的不断迭代，只是事后看起来清晰了很多。

### 1.3 使用规则引擎的优势

使用规则引擎的优势如下：

1、业务规则与系统代码分离，实现业务规则的集中管理

2、在不重启服务的情况下可随时对业务规则进行扩展和维护

3、可以动态修改业务规则，从而快速响应需求变更

4、规则引擎是相对独立的，只关心业务规则，使得业务分析人员也可以参与编辑、维护系统的业务规则

5、减少了硬编码业务规则的成本和风险

6、使用规则引擎提供的规则编辑工具，使复杂的业务规则实现变得的简单

### 1.4 规则引擎应用场景

对于一些存在比较复杂的业务规则并且业务规则会频繁变动的系统比较适合使用规则引擎，如下：

1、风险控制系统----风险贷款、风险评估

2、反欺诈项目----银行贷款、征信验证

3、决策平台系统----财务计算

4、促销平台系统----满减、打折、加价购

## 2 规则引擎怎么做

### 2.1 从实际场景出发

如果公式是如果A，那么B，那么通过下面几个例子看看A、B分别有什么。

**场景1：**

某个地库，红外感应器感应到有车移动，则旁边的10个灯亮，2分钟内车不动，灯灭。

- A1：[某类型红外设备]感应到[车移动]，B1：[旁边10个灯][开关属性设置为开]；
- A2：[某类型红外设备]感应到[2min内没有车移动]，B2：[旁边10个灯][开关属性设置为关]；

**场景2：**

某条街道，所有路灯夏季19：00亮，6：00灭，冬季17：30亮，7：00灭。

- A1：[街上的所有路灯]在[5月1日-8月31日的19点]，B1：[街上所有路灯的开关属性设置为开]；
- A2：[街上的所有路灯]在[5月1日-8月31日的6点]，B2：[街上所有路灯的开关属性设置为关]；
- A3：[街上的所有路灯]在[9月1日-4月30日的17点半]，B3：[街上所有路灯的开关属性设置为开]；
- A4：[街上的所有路灯]在[9月1日-4月30日的7点]，B4：[街上所有路灯的开关属性设置为关]；

**场景3：**

某个家，识别开门人员，非主人的话报警。

- A：[门感应器]在[感应到门开]，B：[报警]；

**场景4：**

某个大型工厂，某类机器的温湿度数据转发至A服务（用于分析环境的服务），某类机器的运行参数，如高度、角度等数据转发至B服务（用于分析机器运转情况的服务）。

- A1：[是X类机器的温度、适度]，B1：[转发至A服务]；
- A2：[是Y类机器的高度、角度]，B2：[转发至B服务]；

以上几个场景可以看出A包括时间点、时间范围、日期范围、设备的属性值、设备的类型等，B可能是状态的变化、产生告警、转发数据等。

接下来的工作就是如何把这些信息整合成界面上易于操作的功能了。

### 2.2 需求的抽象与逻辑的整合

把以上的ABCD进一步抽象：

- 条件：日期、时间、设备的类型、设备的范围、设备的某个属性、设备的某个属性的值；
- 逻辑关系：=、==、≥、≤、!=、>、＜；
- 执行动作：告警、转发、改变属性；

是不是很熟悉，在excel或者木疙瘩、axure等工具里有很多处理类似逻辑的地方。

![img](http://image.woshipm.com/wp-files/2020/10/NYUQzCMndPzEazYsTdRH.jpg)

Excel对逻辑的处理

![img](http://image.woshipm.com/wp-files/2020/10/4TMdDyHUB63Js6oVeybK.jpg)

木疙瘩对逻辑的处理

那么参考这些逻辑，整合出来的页面便是：

![img](http://image.woshipm.com/wp-files/2020/10/4PHOe1JfsTJTBOlVqaUn.jpg)

简单的规则实现

等等，还有好多问题没有考虑清楚：

1）条件间的逻辑关系是“与”还是“或”？（A与A）

- 如果是“与”，那恰好在某个点设备上报数据符合设定条件的情况在现实中存在吗？
- 如果是“与”，用户创建了两个时间点的条件，那这条规则就没意义了吧？

2）动作间的关系是“与”还是“或”？（B与B）

既要将数据转发到别的服务上，又要让某个设备执行某个动作，合理吗？

3）不合理的规则是按照正常（自认为正常）的逻辑写死在程序里还是让用户自己判断？

4）规则什么时候生效，立即生效还是指定时间生效，还是周期生效？

没有标准答案…

其实以上问题没有标准的答案，做成什么样子都要根据现实的需求来。

对于某些简单的场景，规则引擎都没必要做，有些场景，没必要做数据转发。

阿里和华为都把规则引擎分为数据转发和设备联动，这个分法比较通用，而通用的另一面便是抽象，不贴合业务。

贴合业务近的平台可以按照自己的需求划分，比如规则引擎（定时联动、设备联动）、规则引擎（设备联动、告警）、规则引擎（数据转发、定时联动、设备联动）等等。

### 2.3 阿里云物联网平台的规则引擎

![img](http://image.woshipm.com/wp-files/2020/10/GlKA2L9y03GViGjOPk1v.jpg)

阿里云物联网平台的规则引擎

![img](http://image.woshipm.com/wp-files/2020/10/4LWljOsgbWKElhwStWME.jpg)

阿里云物联网平台规则引擎的数据流转

![img](http://image.woshipm.com/wp-files/2020/10/QRTweerkxELi3hVSM2SY.jpg)

阿里云物联网平台规则引擎的设备联动

阿里云把条件分成触发器和执行条件，好处是从代码的角度知道什么时候执行，比如：

- 到点就判断条件；
- 执行动作或者上报的数据符合逻辑就判断条件，执行动作。

这样的设计我理解，规则的执行只能根据设备上报的值或者时间点开始执行程序，只有一个时间范围的时候是无法运行的；但是有些程序员思维，尤其引入“触发器”概念对用户很不友好，见仁见智吧。

条件间逻辑关系与动作间逻辑关系：

1）将条件分成触发器和执行条件，隐含的一层逻辑是触发器和执行条件间是“与”的关系。

2）触发器间的关系明确定义为“或”，可以为时间触发或者设备触发。这样设计是合理的，毕竟不管时间或者设备上报的属性/事件同时满足条件的情况几乎没有。

3）执行条件间的关系明确说明定义为“与”。

当室内温度低于23°C时，如果室内:有人或者有宠物则：打开空调，并将温度调节至26°C。

以上例子需要创建2条联动规则，但是也可以这么设置：

当室内：有人或者有宠物，如果室内：温度低于23°C时，则：打开空调并将温度调节至26°C。

也就是说如何使用，很大一部分由用户的脑洞决定。

4）动作间定义了关系也是“与”，这个设计我认为合理，如果确实有“或”的需求，设计的时候自己选择一个设置在规则中即可，到目前为止，没有碰到过必须是“或”的强需求。

规则的生效时间有如下设计：

- 规则列表有一个是否启动的手动开关，打开后表示规则开始生效。
- 是否指定时间生效设计在执行条件中，用的是明确的时间范围表单。
- 是否指定周期生效设计在触发器中，用的是cron表达式，很灵活，对使用者有一定要求。

![img](http://image.woshipm.com/wp-files/2020/10/vi4DQH54IG1w1ibZSlBf.jpg)

阿里云物联网平台规则引擎规则生效时间设计

### 2.4 华为云IoTDA的规则引擎

![img](http://image.woshipm.com/wp-files/2020/10/0Ei22XGfUQVs2dLwb8mY.jpg)

华为云IoTDA的规则引擎

![img](http://image.woshipm.com/wp-files/2020/10/s7bgWFSBaE7PioEoa3jd.jpg)

华为云IoTDA的数据转发

![img](http://image.woshipm.com/wp-files/2020/10/LpIMODAGFLTi0VRkVobs.jpg)

华为云IoTDA规则引擎的设备联动

华为云就只有执行条件和执行动作，把生效周期和范围这个条件隐含在了规则的基本信息中，个人觉得这样设计对使用者更友好。

条件间逻辑关系与动作间逻辑关系：

1）将生效周期和时间范围放在规则的基础信息中隐含的一层逻辑是生效时间和执行条件间是“与”的关系。

![img](http://image.woshipm.com/wp-files/2020/10/LxwieZiI7x73Ke4m9KLs.jpg)

时间与周期设计

2）执行条件间通过灵活的选项让用户选择是“或”还是“与”，设计很灵活，灵活的反面就是错误操作导致条件间相互矛盾，规则只判断不执行。

![img](http://image.woshipm.com/wp-files/2020/10/vQg1Y4i9vWmD1qou76ho.jpg)

灵活的逻辑关系选择

3）动作间逻辑关系是指定“与”。

4）为了解决触发器的问题设置了触发时效，将时间点拉成了可设置的时间线。

![img](http://image.woshipm.com/wp-files/2020/10/T9Zg7GJphKyOmFalSDhF.jpg)

灵活的逻辑关系选择触发时效

规则的生效时间有如下设计：

- 规则列表有一个是否启动的手动开关，打开后表示规则开始生效。
- 是否指定时间生效设计在规则基础信息中，用的是明确的时间范围表单。
- 是否指定周期生效同样设计在规则基础信息中，指定按照“周”循环，用户很明确知道怎么用，但是按照年、月循环的场景无法实现。

### 2.5 做的时候如何决策和平衡

参考同类型的产品会发现同样的功能如何做都存在优劣势，做好选择便是我们要考虑的问题；而决策的源头不仅是公司面临的实际需求、市场的变化、技术的选型都会影响最后的呈现，一点小小的不同便会导致大大的差别。

而这个软能力并非一蹴而就，我们可能需要一边往前走一边检验，是否做得好甚至还需要一点点运气。

## 3 常见开源规则引擎

### 3.1 Drools

#### 3.1.1 Drools介绍

Drools 是一款由JBoss组织提供的基于Java语言开发的开源规则引擎，可以将复杂且多变的业务规则从硬编码中解放出来，以规则脚本的形式存放在文件或特定的存储介质中(例如存放在数据库中)，使得业务规则的变更不需要修改项目代码、重启服务器就可以在线上环境立即生效。

Drools使用 Rete 算法对所编写的规则求值。Drools  允许使用声明方式表达业务逻辑。

可以使用非 XML 的本地语言编写规则，从而便于学习和理解。并且，还可以将 Java  代码直接嵌入到规则文件中，这令 Drools 的学习更加吸引人。

官网：[http://www.drools.org/#](https://link.jianshu.com?t=http://www.drools.org/#)

官方文档：[http://www.drools.org/learn/documentation.html](https://link.jianshu.com?t=http://www.drools.org/learn/documentation.html)

#### 3.1.2 优点

- 非常活跃的社区支持
- 易用
- 快速的执行速度
- 在 Java 开发人员中流行
- 与 Java Rule Engine API（JSR 94）兼容

### 3.2 EasyRules

#### 3.2.1 概述

Easy Rules是一个简单而强大的Java规则引擎，提供以下功能：

- 轻量级框架和易于学习的API
- 基于POJO的开发与注解的编程模型
- 定义抽象的业务规则并轻松应用它们
- 支持从简单规则创建组合规则的能力
- 支持使用表达式语言（如MVEL和SpEL）定义规则的能力

在一篇非常有趣的规则引擎的[文章](https://link.zhihu.com/?target=http%3A//martinfowler.com/bliki/RulesEngine.html)中，Martin Fowler说：

> 您可以自己构建一个简单的规则引擎。您只需要创建一组具有条件和操作的对象，将它们存储在一个集合中，并运行它们来评估conditions和执行actions。

这正是Easy Rules所做的，它提供了抽象Rule来创建带有conditions和actions的规则，RulesEngine API运行一系列规则来评估conditions和执行actions。

Github地址：https://github.com/j-easy/easy-rules

#### 3.2.2 运行环境

Easy Rules是一个Java库， 需要运行在Java 1.7及以上。

### 3.3 LiteFlow

#### 3.3.1 LiteFlow的特性

- 复杂业务的解耦利器，为所有组件提供统一的实现协议

- 基于规则文件来编排流程，并可进行热编排

- 框架中支持ZooKeeper流程配置，即时推送修改内容

- 能自由扩展配置持久化源，提供扩展接口

- 支持SpringBoot的自动装配，也支持Spring的配置和非Spring的项目

- 提供串行和并行2种模式，提供常见常见的表达式语句

- 提供无级嵌套子流程模式

- 数据槽高并发隔离机制

- 组件的重试机制

- 多种脚本语言的支持

- 自带简单的监控，能够知道每个组件的运行耗时排行

### 3.4 Devs

Devs是一款轻量级的规则引擎。

开源地址：https://github.com/CrankZ/devs

#### 3.4.1 基础概念

此规则引擎的基础概念有字段、条件、规则等。

其中字段组成条件，条件组成规则，并且支持多个条件通过与或组成一个规则。