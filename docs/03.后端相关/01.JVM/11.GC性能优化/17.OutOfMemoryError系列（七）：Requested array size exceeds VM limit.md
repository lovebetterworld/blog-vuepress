---
title: 17.OutOfMemoryError系列（七）：Requested array size exceeds VM limit
date: 2022-09-08 11:20:00
permalink: /GC/GC17/
categories: 
  - JVM
tags: 
  - JVM
---

Java平台限制了数组的最大长度。各个版本的具体限制可能稍有不同, 但范围都在 `1 ~ 21亿` 之间。

![202202131606031781.png](http://image.cmsblogs.com/article/group/common-serial/202202131606031781.png)

如果程序抛出 `java.lang.OutOfMemoryError: Requested array size exceeds VM limit` 错误, 就说明想要创建的数组长度超过限制。

## 原因分析

这个错误是由JVM中的本地代码抛出的. 在真正为数组分配内存之前, JVM会执行一项检查: 要分配的数据结构在该平台是否可以寻址(addressable). 当然, 这个错误比你所想的还要少见得多。

一般很少看到这个错误, 因为Java使用 int 类型作为数组的下标(index, 索引)。在Java中, int类型的最大值为 `2^31 – 1 = 2,147,483,647`。大多数平台的限制都约等于这个值 —— 例如在 64位的 MB Pro 上, Java 1.7 平台可以分配长度为 `2,147,483,645`, 以及 `Integer.MAX_VALUE-2`) 的数组。

再增加一点点长度, 变成 `Integer.MAX_VALUE-1` 时, 就会抛出我们所熟知的 `OutOfMemoryError`:

```
Exception in thread "main" java.lang.OutOfMemoryError: Requested array size exceeds VM limit           
```

在有的平台上, 这个最大限制可能还会更小一些, 例如在32位Linux, OpenJDK 6 上面, 数组长度大约在 11亿左右(约`2^30`) 就会抛出 “`java.lang.OutOfMemoryError: Requested array size exceeds VM limit`“ 错误。要找出具体的限制值, 可以执行一个小小的测试用例, 具体示例参见下文。

## 示例

以下代码用来演示 `java.lang.OutOfMemoryError: Requested array size exceeds VM limit` 错误:

```java
for (int i = 3; i >= 0; i--) {
    try {
        int[] arr = new int[Integer.MAX_VALUE-i];
        System.out.format("Successfully initialized an array with %,d elements.\n", Integer.MAX_VALUE-i);
    } catch (Throwable t) {
        t.printStackTrace();
    }
}
```

其中,for循环迭代4次, 每次都去初始化一个 int 数组, 长度从 `Integer.MAX_VALUE-3` 开始递增, 到 `Integer.MAX_VALUE` 为止. 在 64位 Mac OS X 的 Hotspot 7 平台上, 执行这段代码会得到类似下面这样的结果:

```java
java.lang.OutOfMemoryError: Java heap space
          at eu.plumbr.demo.ArraySize.main(ArraySize.java:8)
        java.lang.OutOfMemoryError: Java heap space
          at eu.plumbr.demo.ArraySize.main(ArraySize.java:8)
        java.lang.OutOfMemoryError: Requested array size exceeds VM limit
          at eu.plumbr.demo.ArraySize.main(ArraySize.java:8)
        java.lang.OutOfMemoryError: Requested array size exceeds VM limit
          at eu.plumbr.demo.ArraySize.main(ArraySize.java:8)
```

请注意, 在后两次迭代抛出 `java.lang.OutOfMemoryError: Requested array size exceeds VM limit` 错误之前, 先抛出了2次 `java.lang.OutOfMemoryError: Java heap space` 错误。 这是因为 `2^31-1` 个 int 数占用的内存超过了JVM默认的8GB堆内存。

此示例也展示了这个错误比较罕见的原因 —— 要取得JVM对数组大小的限制, 要分配长度差不多等于 `Integer.MAX_INT` 的数组. 这个示例运行在64位的Mac OS X, Hotspot 7平台时, 只有两个长度会抛出这个错误: `Integer.MAX_INT-1` 和 `Integer.MAX_INT`。

## 解决方案

发生 `java.lang.OutOfMemoryError: Requested array size exceeds VM limit` 错误的原因可能是:

- 数组太大, 最终长度超过平台限制值, 但小于 `Integer.MAX_INT`
- 为了测试系统限制, 故意分配长度大于 `2^31-1` 的数组。

第一种情况, 需要检查业务代码, 确认是否真的需要那么大的数组。如果可以减小数组长度, 那就万事大吉. 如果不行，可能需要把数据拆分为多个块, 然后根据需要按批次加载。

如果是第二种情况, 请记住, Java 数组用 int 值作为索引。所以数组元素不能超过 `2^31-1` 个. 实际上, 代码在编译阶段就会报错,提示信息为 “`error: integer number too large`”。

如果确实需要处理超大数据集, 那就要考虑调整解决方案了. 例如拆分成多个小块,按批次加载; 或者放弃使用标准库,而是自己处理数据结构,比如使用 `sun.misc.Unsafe` 类, 通过Unsafe工具类可以像C语言一样直接分配内存。