---
title: 30.RocketMQ（二十一）死信队列
date: 2022-09-21 14:51:21
permalink: /RocketMQ/RocketMQ21/
categories: 
  - RocketMQ
tags: 
  - RocketMQ
---

## 1、什么是死信队列

当一条消息初次消费失败，消息队列会自动进行消费重试；达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息，此时，消息队列不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。这个队列就是死信队列（Dead-Letter Queue，DLQ），而其中的消息则称为死信消息（Dead-Letter Message，DLM）。

> 死信队列是用于处理无法被正常消费的消息的。

## 2、死信队列的特征

死信队列具有如下特征：

- 死信队列中的消息不会再被消费者正常消费，即DLQ对于消费者是不可见的
- 死信存储有效期与正常消息相同，均为 3 天（commitlog文件的过期时间），3 天后会被自动删除
- 死信队列就是一个特殊的Topic，名称为%DLQ%consumerGroup ，即每个消费者组都有一个死信队列
- 如果⼀个消费者组未产生死信消息，则不会为其创建相应的死信队列

## 3、死信消息的处理

实际上，当⼀条消息进入死信队列，就意味着系统中某些地方出现了问题，从而导致消费者无法正常消费该消息，比如代码中原本就存在Bug。因此，对于死信消息，通常需要开发人员进行特殊处理。最关键的步骤是要排查可疑因素，解决代码中可能存在的Bug，然后再将原来的死信消息再次进行投递消费。

## 4、死信队列默认无法消费

死信的perm默认是2，表示只写。

> perm用于设置对当前创建Topic的操作权限：2表示只写，4表示只读，6表示读写。

如果想消费死信队列的消息，需要修改perm的值为6，便可消费，操作如下

![image-20220921152511300](https://www.lovebetterworld.com:8443/uploads/2022/09/21/632ac3681545f.png)

![image-20220921152528325](https://www.lovebetterworld.com:8443/uploads/2022/09/21/632ac36a6b6d9.png)